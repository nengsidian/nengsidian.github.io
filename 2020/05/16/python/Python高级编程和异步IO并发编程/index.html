<!DOCTYPE HTML>
<html lang="zh-CN">

<head>
    <!--Setting-->
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="IE=Edge,chrome=1">
    <meta http-equiv="Cache-Control" content="no-siteapp">
    <meta http-equiv="Cache-Control" content="no-transform">
    <meta name="renderer" content="webkit|ie-comp|ie-stand">
    <meta name="apple-mobile-web-app-capable" content="李恒的博客">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="format-detection" content="telephone=no,email=no,adress=no">
    <meta name="browsermode" content="application">
    <meta name="screen-orientation" content="portrait">
    <meta name="theme-version" content="1.2.3">
    <meta name="root" content="/">
    <link rel="dns-prefetch" href="http://yoursite.com">
    <!--SEO-->

<meta name="keywords" content="python,IO" />


<meta name="description" content="第二章 一切皆对象函数和类也是对象，属于python的一等公民
函数和类可以赋值给一个变量
函数和类可以添加到集合对象中
函数和类可以作为参数传递给函数
可以当做函数的返回值

type、cla..." />


<meta name="robots" content="all" />
<meta name="google" content="all" />
<meta name="googlebot" content="all" />
<meta name="verify" content="all" />
    <!--Title-->

<title>
    
    python高级编程和异步IO并发编程 |
    
    李恒的博客
</title>

<link rel="alternate" href="/atom.xml" title="李恒的博客" type="application/atom+xml">


<link rel="icon" href="./favicon.ico">

    


<link rel="stylesheet" href="/css/bootstrap.min.css?rev=3.3.7.css">
<link rel="stylesheet" href="/css/font-awesome.min.css?rev=4.7.0.css">
<link rel="stylesheet" href="/css/style.css?rev=@@hash.css">

    
<div class="hide">
    <script type="text/javascript">
    var cnzz_protocol = (("https:" == document.location.protocol) ? " https://" : " http://");
    document.write(unescape("%3Cspan class='cnzz_stat_icon_1263868967 hide' %3E%3Cscript%20src%3D%22https%3A%2F%2Fs95.cnzz.com%2Fz_stat.php%3Fweb_id%3D1272564536%22%3E%3C%2Fscript%3E%3C/span%3E%3Cscript src='" + cnzz_protocol + "s19.cnzz.com/z_stat.php%3Fid%3D1263868967%26show%3Dpic1' type='text/javascript'%3E%3C/script%3E"));
    </script>
</div>




    

<meta name="generator" content="Hexo 4.2.1"></head>
<!--[if lte IE 8]>
<style>
    html{ font-size: 1em }
</style>
<![endif]-->
<!--[if lte IE 9]>
<div style="ie">你使用的浏览器版本过低，为了你更好的阅读体验，请更新浏览器的版本或者使用其他现代浏览器，比如Chrome、Firefox、Safari等。</div>
<![endif]-->
<body>
    <header class="main-header"  style="background-image:url(
    http://snippet.shenliyang.com/img/banner.jpg)"
     >
    <div class="main-header-box">
        <a class="header-avatar" href="/" title='liheng'>
            <img src="/img/avatar.jpg" alt="logo头像" class="img-responsive center-block">
        </a>
        <div class="branding">
            <!--<h2 class="text-hide">Snippet主题,从未如此简单有趣</h2>-->
            
            <img src="/img/branding.png" alt="Snippet 博客主题" class="img-responsive center-block">
            
        </div>
    </div>
</header>
    <nav class="main-navigation">
    <div class="container">
        <div class="row">
            <div class="col-sm-12">
                <div class="navbar-header"><span class="nav-toggle-button collapsed pull-right" data-toggle="collapse" data-target="#main-menu" id="mnav">
                        <span class="sr-only"></span>
                        <i class="fa fa-bars"></i>
                    </span>
                    <a class="navbar-brand" href="http://yoursite.com">
                        李恒的博客</a>
                </div>
                <div class="collapse navbar-collapse" id="main-menu">
                    <ul class="menu">
                        
                        <li role="presentation" class="text-center">
                            <a href="/"><i class="fa "></i>
                                首页</a>
                        </li>
                        
                        <li role="presentation" class="text-center">
                            <a href="/categories/python/"><i class="fa "></i>
                                python</a>
                        </li>
                        
                        <li role="presentation" class="text-center">
                            <a href="/categories/java/"><i class="fa "></i>
                                java</a>
                        </li>
                        
                        <li role="presentation" class="text-center">
                            <a href="/categories/前端/"><i class="fa "></i>
                                前端</a>
                        </li>
                        
                        <li role="presentation" class="text-center">
                            <a href="/categories/数据库/"><i class="fa "></i>
                                数据库</a>
                        </li>
                        
                        <li role="presentation" class="text-center">
                            <a href="/categories/其他/"><i class="fa "></i>
                                其他</a>
                        </li>
                        
                        <li role="presentation" class="text-center">
                            <a href="/archives/"><i class="fa "></i>
                                时间轴</a>
                        </li>
                        
                    </ul>
                </div>
            </div>
        </div>
    </div>
</nav>
    <section class="content-wrap">
        <div class="container">
            <div class="row">
                <main class="col-md-8 main-content m-post">
                    <p id="process"></p>
<article class="post">
    <div class="post-head">
        <h1 id="python高级编程和异步IO并发编程">
            
            python高级编程和异步IO并发编程
            
        </h1>
        <div class="post-meta">
    
    <span class="categories-meta fa-wrap">
        <i class="fa fa-folder-open-o"></i>
        <a class="category-link" href="/categories/python/">python</a>
    </span>
    
    
    <span class="fa-wrap">
        <i class="fa fa-tags"></i>
        <span class="tags-meta">
            
            <a class="tag-link" href="/tags/IO/" rel="tag">IO</a> <a class="tag-link" href="/tags/python/" rel="tag">python</a>
            
        </span>
    </span>
    
    
    
    <span class="fa-wrap">
        <i class="fa fa-clock-o"></i>
        <span class="date-meta">
            2020/05/16</span>
    </span>
    
    
</div>
        
        
    </div>
    
    <div class="post-body post-content">
        <h1 id="第二章-一切皆对象"><a href="#第二章-一切皆对象" class="headerlink" title="第二章 一切皆对象"></a>第二章 一切皆对象</h1><h4 id="函数和类也是对象，属于python的一等公民"><a href="#函数和类也是对象，属于python的一等公民" class="headerlink" title="函数和类也是对象，属于python的一等公民"></a>函数和类也是对象，属于python的一等公民</h4><ul>
<li>函数和类可以赋值给一个变量</li>
<li>函数和类可以添加到集合对象中</li>
<li>函数和类可以作为参数传递给函数</li>
<li>可以当做函数的返回值</li>
</ul>
<h4 id="type、class、object之间的关系"><a href="#type、class、object之间的关系" class="headerlink" title="type、class、object之间的关系"></a>type、class、object之间的关系</h4><p>type→class→obj</p>
<p>例如：type→int→1</p>
<p>例如：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Student</span>:</span></span><br><span class="line">    <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line">stu = Student()</span><br><span class="line">print(type(stu))</span><br><span class="line">print(type(Student))</span><br></pre></td></tr></table></figure>

<p>输出：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&lt;<span class="class"><span class="keyword">class</span> '<span class="title">__main__</span>.<span class="title">Student</span>'&gt;</span></span><br><span class="line"><span class="class">&lt;<span class="title">class</span> '<span class="title">type</span>'&gt;</span></span><br></pre></td></tr></table></figure>



<p>object是最顶层的基类</p>
<p><img src="/2020/05/16/python/Python%E9%AB%98%E7%BA%A7%E7%BC%96%E7%A8%8B%E5%92%8C%E5%BC%82%E6%AD%A5IO%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B/WX20190518-094838@2x.png" alt></p>
<h1 id="第三章-魔法函数"><a href="#第三章-魔法函数" class="headerlink" title="第三章 魔法函数"></a>第三章 魔法函数</h1><h4 id="getitem"><a href="#getitem" class="headerlink" title="__getitem__"></a><code>__getitem__</code></h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Company</span><span class="params">(object)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, employee_list)</span>:</span></span><br><span class="line">        self.employee = employee_list</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__getitem__</span><span class="params">(self, item)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> self.employee[item]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">company = Company([<span class="string">"tom"</span>, <span class="string">"bob"</span>, <span class="string">"jane"</span>])</span><br><span class="line"></span><br><span class="line">company1 = company[:<span class="number">2</span>]</span><br><span class="line"></span><br><span class="line">print(len(company))</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> em <span class="keyword">in</span> company1:</span><br><span class="line">    print(em)</span><br></pre></td></tr></table></figure>



<h4 id="repr"><a href="#repr" class="headerlink" title="__repr__"></a><code>__repr__</code></h4><p>如果在一个类中定义了<code>__repr__</code>方法，那么在开发模式下，输出对象显示该方法的返回值</p>
<h4 id="str"><a href="#str" class="headerlink" title="__str__"></a><code>__str__</code></h4><p>如果一个类中定义了<code>__str__</code>方法，那么在打印 对象 时，默认输出该方法的返回值。</p>
<h4 id="abs"><a href="#abs" class="headerlink" title="__abs__"></a><code>__abs__</code></h4><p>绝对值</p>
<p><img src="/2020/05/16/python/Python%E9%AB%98%E7%BA%A7%E7%BC%96%E7%A8%8B%E5%92%8C%E5%BC%82%E6%AD%A5IO%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B/WX20190518-104614@2x.png" alt></p>
<h4 id="add"><a href="#add" class="headerlink" title="__add__"></a><code>__add__</code></h4><p>+</p>
<p><img src="/2020/05/16/python/Python%E9%AB%98%E7%BA%A7%E7%BC%96%E7%A8%8B%E5%92%8C%E5%BC%82%E6%AD%A5IO%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B/WX20190518-104539@2x.png" alt></p>
<h4 id="len"><a href="#len" class="headerlink" title="__len__"></a><code>__len__</code></h4><p>显示长度，效率很高</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Company</span><span class="params">(object)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, employee_list)</span>:</span></span><br><span class="line">        self.employee = employee_list</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__len__</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> len(self.employee)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">company = Company([<span class="string">"tom"</span>, <span class="string">"bob"</span>, <span class="string">"jane"</span>])</span><br><span class="line"></span><br><span class="line">print(len(company))</span><br></pre></td></tr></table></figure>



<h4 id="mro"><a href="#mro" class="headerlink" title="__mro__"></a><code>__mro__</code></h4><p>打印类的属性和方法的查找顺序</p>
<h4 id="dict"><a href="#dict" class="headerlink" title="__dict__"></a><code>__dict__</code></h4><p>显示类或对象的所以属性和方法，也可以通过它添加属性和方法</p>
<h4 id="enter-、-exit"><a href="#enter-、-exit" class="headerlink" title="__enter__、__exit__"></a><code>__enter__</code>、<code>__exit__</code></h4><p>实现上下文管理器，见第四章的上下文管理器</p>
<h4 id="getattr-、-getattribute"><a href="#getattr-、-getattribute" class="headerlink" title="__getattr__、__getattribute__"></a><code>__getattr__</code>、<code>__getattribute__</code></h4><p><code>__getattr__</code>：当查找的属性不存在时，会进入<code>__getattr__</code></p>
<p><code>__getattribute__</code>:只要调用属性，就会先进入<code>__getattribute__</code></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">User</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, info=&#123;&#125;)</span>:</span></span><br><span class="line">        self.info = info</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 方法里的参数item就是对应的属性</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__getattr__</span><span class="params">(self, item)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> self.info[item]</span><br><span class="line"></span><br><span class="line">    <span class="comment"># def __getattribute__(self, item):</span></span><br><span class="line">    <span class="comment">#     return "bobby"</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">"__main__"</span>:</span><br><span class="line">    user = User(info=&#123;<span class="string">"company_name"</span>: <span class="string">"imooc"</span>, <span class="string">"name"</span>: <span class="string">"bobby"</span>&#125;)</span><br><span class="line">    print(user.test)</span><br></pre></td></tr></table></figure>



<h1 id="第四章-深入类和对象"><a href="#第四章-深入类和对象" class="headerlink" title="第四章 深入类和对象"></a>第四章 深入类和对象</h1><h4 id="鸭子类型和多态"><a href="#鸭子类型和多态" class="headerlink" title="鸭子类型和多态"></a>鸭子类型和多态</h4><p>所有类实现了一个共同的方法，这种方法叫做鸭，这些类就可以归为一种类型，都是鸭子类型，他们都可以调用这个鸭方法。所以也可以理解为，某一个类只要实现了某种魔法方法，那么这个类就是这个方法对应的某种类型。例如：某个类实现了<code>__iter__</code>方法，那么这个类就是可迭代类型。</p>
<p>而每个类的这个鸭方法可能又不一样，就叫做多态。</p>
<p>举例：list、tuple、set都是可迭代类型，他们都有魔法方法<code>__iter__</code>使他们成为可迭代对象，可是它们具体的<code>__iter__</code>方法可能又不一样。</p>
<p>在python中传参数时经常是传一种类型就可以了，而不是一定要传某种对象，例如list的extend方法，传入可迭代类型就可以，而不是一定要传入list对象。</p>
<h4 id="抽象基类-abc模块"><a href="#抽象基类-abc模块" class="headerlink" title="抽象基类(abc模块)"></a>抽象基类(abc模块)</h4><p>主要的两个作用：</p>
<p>1、可以使用isinstance判断某个对象的类型</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> collections.abc <span class="keyword">import</span> Sized</span><br><span class="line">isinstance(com, Sized)</span><br></pre></td></tr></table></figure>

<p>2、强制指定某个子类必须要实现某个方法</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> abc</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">CacheBase</span><span class="params">(metaclass=abc.ABCMeta)</span>:</span></span><br><span class="line"><span class="meta">    @abc.abstractmethod</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get</span><span class="params">(self, key)</span>:</span></span><br><span class="line">        <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line"><span class="meta">    @abc.abstractmethod</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">set</span><span class="params">(self, key, value)</span>:</span></span><br><span class="line">        <span class="keyword">pass</span></span><br></pre></td></tr></table></figure>

<p>使用上述抽象基类的方法后，如果子类没有实现这些方法，在实例化时就会抛出异常</p>
<p>一般不推荐使用抽象基类，因为如果使用抽象基类，容易代码设计过度，导致一些不必要的麻烦，如果要通过继承实现某些方法，推荐用mixin，或实现某些魔法方法。</p>
<p>模拟一个抽象基类：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">CacheBase</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get</span><span class="params">(self, key)</span>:</span></span><br><span class="line">        <span class="keyword">raise</span> NotImplementedError</span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">set</span><span class="params">(self, key, value)</span>:</span></span><br><span class="line">        <span class="keyword">raise</span> NotImplementedError</span><br></pre></td></tr></table></figure>

<p>上述是模拟抽象基类的方法，可以在子类继承后，如果没有重写这些方法，那么在使用这些方法时就会抛出异常。</p>
<h4 id="isinstance和type"><a href="#isinstance和type" class="headerlink" title="isinstance和type"></a>isinstance和type</h4><p>判断一个变量的类型时尽量用isinstance，因为isinstance在判断时会把继承关系也判断进去，而如果用type则会出现误差。</p>
<h4 id="数据封装和私有属性"><a href="#数据封装和私有属性" class="headerlink" title="数据封装和私有属性"></a>数据封装和私有属性</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> chapter04.class_method <span class="keyword">import</span> Date</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">User</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, birthday)</span>:</span></span><br><span class="line">        self.__birthday = birthday</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get_age</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="comment"># 返回年龄</span></span><br><span class="line">        <span class="keyword">return</span> <span class="number">2018</span> - self.__birthday.year</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">"__main__"</span>:</span><br><span class="line">    user = User(Date(<span class="number">1990</span>, <span class="number">2</span>, <span class="number">1</span>))</span><br><span class="line">    print(user._User__birthday)</span><br><span class="line">    print(user.get_age())</span><br></pre></td></tr></table></figure>



<h4 id="python对象的自省机制"><a href="#python对象的自省机制" class="headerlink" title="python对象的自省机制"></a>python对象的自省机制</h4><p>自省是通过一定的机制查询到对象的内部结构</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Person</span>:</span></span><br><span class="line">    <span class="string">"""人"""</span></span><br><span class="line">    name = <span class="string">"user"</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Student</span><span class="params">(Person)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, scool_name)</span>:</span></span><br><span class="line">        self.scool_name = scool_name</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">"__main__"</span>:</span><br><span class="line">    user = Student(<span class="string">"慕课网"</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 通过__dict__查询属性</span></span><br><span class="line">    print(user.__dict__)</span><br><span class="line">    <span class="comment"># 也可以通过__dict__添加属性</span></span><br><span class="line">    user.__dict__[<span class="string">"school_addr"</span>] = <span class="string">"北京市"</span></span><br><span class="line">    print(user.school_addr)</span><br><span class="line">    print(Person.__dict__)</span><br><span class="line">    print(user.name)</span><br><span class="line">    a = [<span class="number">1</span>, <span class="number">2</span>]</span><br><span class="line">    <span class="comment"># dir函数比__dict__更加强大，列表使用__dict__会报错，dir函数则不会</span></span><br><span class="line">    print(dir(a))</span><br></pre></td></tr></table></figure>



<h4 id="super函数"><a href="#super函数" class="headerlink" title="super函数"></a>super函数</h4><p>super函数的执行顺序是根据<code>__mro__</code>的继承顺序，如果根据<code>__mro__</code>的顺序，其中的一个类C没有super()方法，那么C后面的继承就会中断，只继承C和C前面的</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">A</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self)</span>:</span></span><br><span class="line">        print(<span class="string">"A"</span>)</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">B</span><span class="params">(A)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self)</span>:</span></span><br><span class="line">        print(<span class="string">"B"</span>)</span><br><span class="line">        super().__init__()</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">C</span><span class="params">(A)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self)</span>:</span></span><br><span class="line">        print(<span class="string">"C"</span>)</span><br><span class="line">        <span class="comment"># super().__init__()</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">D</span><span class="params">(B, C)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self)</span>:</span></span><br><span class="line">        print(<span class="string">"D"</span>)</span><br><span class="line">        super(D, self).__init__()</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">"__main__"</span>:</span><br><span class="line">    print(D.__mro__)</span><br><span class="line">    d = D()</span><br></pre></td></tr></table></figure>

<p>执行结果</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">(&lt;class '__main__.D'&gt;, &lt;class '__main__.B'&gt;, &lt;class '__main__.C'&gt;, &lt;class '__main__.A'&gt;, &lt;class 'object'&gt;)</span><br><span class="line">D</span><br><span class="line">B</span><br><span class="line">C</span><br></pre></td></tr></table></figure>



<h4 id="mixin混合模式"><a href="#mixin混合模式" class="headerlink" title="mixin混合模式"></a>mixin混合模式</h4><p>mixin模式特点</p>
<ol>
<li>Mixin类功能单一 </li>
<li>不和基类关联，可以和任意基类组合， 基类可以不和mixin关联就能初始化成功 </li>
<li>在mixin中不要使用super这种用法</li>
</ol>
<h4 id="异常处理和上下文管理器"><a href="#异常处理和上下文管理器" class="headerlink" title="异常处理和上下文管理器"></a>异常处理和上下文管理器</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">exe_try</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        print(<span class="string">"code started"</span>)</span><br><span class="line">        <span class="keyword">raise</span> KeyError</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span></span><br><span class="line">    <span class="keyword">except</span> KeyError <span class="keyword">as</span> e:</span><br><span class="line">        print(<span class="string">"key error"</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="number">2</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        print(<span class="string">"other error"</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="number">3</span></span><br><span class="line">    <span class="keyword">finally</span>:</span><br><span class="line">        print(<span class="string">"finally"</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="number">4</span></span><br><span class="line"><span class="comment"># 以上代码执行结果是：</span></span><br><span class="line">code started</span><br><span class="line">key error</span><br><span class="line"><span class="keyword">finally</span></span><br><span class="line"><span class="number">4</span></span><br><span class="line"><span class="comment"># 如果注释了finally中的return 4，那么执行结果就会变成</span></span><br><span class="line">code started</span><br><span class="line">key error</span><br><span class="line"><span class="keyword">finally</span></span><br><span class="line"><span class="number">2</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 上下文管理器协议</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Sample</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__enter__</span><span class="params">(self)</span>:</span></span><br><span class="line">        print(<span class="string">"enter"</span>)</span><br><span class="line">        <span class="comment"># 获取资源</span></span><br><span class="line">        <span class="keyword">return</span> self  <span class="comment"># 此处一定要return self</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__exit__</span><span class="params">(self, exc_type, exc_val, exc_tb)</span>:</span></span><br><span class="line">        <span class="comment"># 释放资源</span></span><br><span class="line">        print(<span class="string">"exit"</span>)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">do_something</span><span class="params">(self)</span>:</span></span><br><span class="line">        print(<span class="string">"doing something"</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">with</span> Sample() <span class="keyword">as</span> sample:</span><br><span class="line">    sample.do_something()</span><br></pre></td></tr></table></figure>



<h4 id="简化上下文管理器"><a href="#简化上下文管理器" class="headerlink" title="简化上下文管理器"></a>简化上下文管理器</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> contextlib</span><br><span class="line"></span><br><span class="line"><span class="meta">@contextlib.contextmanager</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">file_open</span><span class="params">(file_name)</span>:</span></span><br><span class="line">    print(<span class="string">"file open"</span>)</span><br><span class="line">    <span class="comment"># yield前的代码先执行，相当于上面的__enter__内的内容</span></span><br><span class="line">    <span class="keyword">yield</span> &#123;&#125;</span><br><span class="line">    <span class="comment"># yield后的代码最后执行，相当于上面的__exit__内的内容</span></span><br><span class="line">    print(<span class="string">"file end"</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">with</span> file_open(<span class="string">"bobby.txt"</span>) <span class="keyword">as</span> f_opened:</span><br><span class="line">  <span class="comment"># with内执行的代码(也就是下面的代码)，相当于上面的do_something内的内容</span></span><br><span class="line">    print(<span class="string">"file processing"</span>)</span><br></pre></td></tr></table></figure>



<h1 id="第五章-自定义序列类"><a href="#第五章-自定义序列类" class="headerlink" title="第五章 自定义序列类"></a>第五章 自定义序列类</h1><h4 id="序列类型区分"><a href="#序列类型区分" class="headerlink" title="序列类型区分"></a>序列类型区分</h4><p>区分维度1：</p>
<p>容器序列（list、tuple、deque）：存放的数据可以是任意类型的。</p>
<p>扁平序列(str、bytes、bytearray、array.array)：只能存放一种类型的数据。</p>
<p>区分维度2：</p>
<p>可变序列：list， deque，bytearray、array。</p>
<p>不可变序列：str、tuple、bytes。</p>
<h4 id="、-、extend、append"><a href="#、-、extend、append" class="headerlink" title="+、+=、extend、append"></a>+、+=、extend、append</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> collections <span class="keyword">import</span> abc</span><br><span class="line"><span class="comment"># +号两侧必须是同种类型，相加后返回一个新的序列</span></span><br><span class="line">a = [<span class="number">1</span>, <span class="number">2</span>]</span><br><span class="line">c = a + [<span class="number">3</span>, <span class="number">4</span>]</span><br><span class="line"></span><br><span class="line"><span class="comment"># 就地加，不会产生新的序列，和extend相同，所相加的为可迭代类型即可</span></span><br><span class="line">a += (<span class="number">3</span>, <span class="number">4</span>)</span><br><span class="line">a.extend(range(<span class="number">3</span>))</span><br><span class="line"></span><br><span class="line">a.append((<span class="number">1</span>, <span class="number">2</span>))</span><br><span class="line">print(a)</span><br></pre></td></tr></table></figure>



<h4 id="切片"><a href="#切片" class="headerlink" title="切片"></a>切片</h4><p>会产生一个新的序列</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 模式[start:end:step]</span></span><br><span class="line"><span class="string">"""</span></span><br><span class="line"><span class="string">    其中，第一个数字start表示切片开始位置，默认为0；</span></span><br><span class="line"><span class="string">    第二个数字end表示切片截止（但不包含）位置（默认为列表长度）；</span></span><br><span class="line"><span class="string">    第三个数字step表示切片的步长（默认为1）。</span></span><br><span class="line"><span class="string">    当start为0时可以省略，当end为列表长度时可以省略，</span></span><br><span class="line"><span class="string">    当step为1时可以省略，并且省略步长时可以同时省略最后一个冒号。</span></span><br><span class="line"><span class="string">    另外，当step为负整数时，表示反向切片，这时start应该比end的值要大才行。</span></span><br><span class="line"><span class="string">"""</span></span><br><span class="line">aList = [<span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>, <span class="number">6</span>, <span class="number">7</span>, <span class="number">9</span>, <span class="number">11</span>, <span class="number">13</span>, <span class="number">15</span>, <span class="number">17</span>]</span><br><span class="line">print(aList[::])  <span class="comment"># 返回包含原列表中所有元素的新列表</span></span><br><span class="line">print(aList[::<span class="number">-1</span>])  <span class="comment"># 返回包含原列表中所有元素的逆序列表</span></span><br><span class="line">print(aList[::<span class="number">2</span>])  <span class="comment"># 隔一个取一个，获取偶数位置的元素</span></span><br><span class="line">print(aList[<span class="number">1</span>::<span class="number">2</span>])  <span class="comment"># 隔一个取一个，获取奇数位置的元素</span></span><br><span class="line">print(aList[<span class="number">3</span>:<span class="number">6</span>])  <span class="comment"># 指定切片的开始和结束位置</span></span><br><span class="line">aList[<span class="number">0</span>:<span class="number">100</span>]  <span class="comment"># 切片结束位置大于列表长度时，从列表尾部截断</span></span><br><span class="line">aList[<span class="number">100</span>:]  <span class="comment"># 切片开始位置大于列表长度时，返回空列表</span></span><br><span class="line"></span><br><span class="line">aList[len(aList):] = [<span class="number">9</span>]  <span class="comment"># 在列表尾部增加元素</span></span><br><span class="line">aList[:<span class="number">0</span>] = [<span class="number">1</span>, <span class="number">2</span>]  <span class="comment"># 在列表头部插入元素</span></span><br><span class="line">aList[<span class="number">3</span>:<span class="number">3</span>] = [<span class="number">4</span>]  <span class="comment"># 在列表中间位置插入元素</span></span><br><span class="line">aList[:<span class="number">3</span>] = [<span class="number">1</span>, <span class="number">2</span>]  <span class="comment"># 替换列表元素，等号两边的列表长度相等</span></span><br><span class="line">aList[<span class="number">3</span>:] = [<span class="number">4</span>, <span class="number">5</span>, <span class="number">6</span>]  <span class="comment"># 等号两边的列表长度也可以不相等</span></span><br><span class="line">aList[::<span class="number">2</span>] = [<span class="number">0</span>] * <span class="number">3</span>  <span class="comment"># 隔一个修改一个</span></span><br><span class="line">print(aList)</span><br><span class="line">aList[::<span class="number">2</span>] = [<span class="string">'a'</span>, <span class="string">'b'</span>, <span class="string">'c'</span>]  <span class="comment"># 隔一个修改一个</span></span><br><span class="line">aList[::<span class="number">2</span>] = [<span class="number">1</span>, <span class="number">2</span>]  <span class="comment"># 此条会抛异常，左侧切片不连续，等号两边列表长度必须相等</span></span><br><span class="line">aList[:<span class="number">3</span>] = []  <span class="comment"># 删除列表中前3个元素</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">del</span> aList[:<span class="number">3</span>]  <span class="comment"># 切片元素连续</span></span><br><span class="line"><span class="keyword">del</span> aList[::<span class="number">2</span>]  <span class="comment"># 切片元素不连续，隔一个删一个</span></span><br></pre></td></tr></table></figure>

<p>实现一个可切片的序列类</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> numbers</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Group</span>:</span></span><br><span class="line">    <span class="comment"># 支持切片操作</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, group_name, company_name, staffs)</span>:</span></span><br><span class="line">        self.group_name = group_name</span><br><span class="line">        self.company_name = company_name</span><br><span class="line">        self.staffs = staffs</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__reversed__</span><span class="params">(self)</span>:</span>  <span class="comment"># 实现反转</span></span><br><span class="line">        self.staffs.reverse()</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__getitem__</span><span class="params">(self, item)</span>:</span>  <span class="comment"># 实现可切片</span></span><br><span class="line">        cls = type(self)</span><br><span class="line">        <span class="keyword">if</span> isinstance(item, slice):  <span class="comment"># 如果传入的是切片</span></span><br><span class="line">            <span class="keyword">return</span> cls(group_name=self.group_name, company_name=self.company_name, staffs=self.staffs[item])</span><br><span class="line">        <span class="keyword">elif</span> isinstance(item, numbers.Integral):  <span class="comment"># 如果传入的是索引</span></span><br><span class="line">            <span class="keyword">return</span> cls(group_name=self.group_name, company_name=self.company_name, staffs=[self.staffs[item]])</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__len__</span><span class="params">(self)</span>:</span>  <span class="comment"># 实现长度</span></span><br><span class="line">        <span class="keyword">return</span> len(self.staffs)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__iter__</span><span class="params">(self)</span>:</span>  <span class="comment"># 实现可遍历</span></span><br><span class="line">        <span class="keyword">return</span> iter(self.staffs)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__contains__</span><span class="params">(self, item)</span>:</span>  <span class="comment"># 实现if···in···：</span></span><br><span class="line">        <span class="keyword">if</span> item <span class="keyword">in</span> self.staffs:</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">staffs = [<span class="string">"bobby1"</span>, <span class="string">"imooc"</span>, <span class="string">"bobby2"</span>, <span class="string">"bobby3"</span>]</span><br><span class="line">group = Group(company_name=<span class="string">"imooc"</span>, group_name=<span class="string">"user"</span>, staffs=staffs)</span><br><span class="line">reversed(group)</span><br><span class="line"><span class="keyword">for</span> user <span class="keyword">in</span> group:</span><br><span class="line">    print(user)</span><br><span class="line">group[<span class="number">0</span>:<span class="number">2</span>]</span><br><span class="line">group[<span class="number">0</span>]</span><br></pre></td></tr></table></figure>



<h4 id="bisect管理可排序序列"><a href="#bisect管理可排序序列" class="headerlink" title="bisect管理可排序序列"></a>bisect管理可排序序列</h4><p>用来处理已排序的序列，用来维持已排序的序列，升序</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> bisect</span><br><span class="line"><span class="keyword">from</span> collections <span class="keyword">import</span> deque</span><br><span class="line"></span><br><span class="line"><span class="comment"># 用来处理已排序的序列，用来维持已排序的序列， 升序</span></span><br><span class="line"><span class="comment"># 二分查找</span></span><br><span class="line">inter_list = list()</span><br><span class="line">bisect.insort(inter_list, <span class="number">3</span>)</span><br><span class="line">bisect.insort(inter_list, <span class="number">2</span>)</span><br><span class="line">bisect.insort(inter_list, <span class="number">5</span>)</span><br><span class="line">bisect.insort(inter_list, <span class="number">1</span>)</span><br><span class="line">bisect.insort(inter_list, <span class="number">6</span>)</span><br><span class="line"></span><br><span class="line">print(bisect.bisect_left(inter_list, <span class="number">3</span>))</span><br><span class="line">print(bisect.bisect_left(inter_list, <span class="number">3</span>))</span><br><span class="line"><span class="comment"># 学习成绩</span></span><br><span class="line">print(inter_list)</span><br></pre></td></tr></table></figure>



<h4 id="什么时候我们不该使用列表"><a href="#什么时候我们不该使用列表" class="headerlink" title="什么时候我们不该使用列表"></a>什么时候我们不该使用列表</h4><p>array(数组)：数组只能存放指定的数据类型，但是效率要比列表高很多，所以如果存放的都是一种数据，建议使用array</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># array, deque</span></span><br><span class="line"><span class="comment"># 数组</span></span><br><span class="line"><span class="keyword">import</span> array</span><br><span class="line"><span class="comment">#array和list的一个重要区别， array只能存放指定的数据类型</span></span><br><span class="line">my_array = array.array(<span class="string">"i"</span>)</span><br><span class="line">my_array.append(<span class="number">1</span>)</span><br><span class="line">my_array.append(<span class="string">"abc"</span>)</span><br></pre></td></tr></table></figure>

<p><img src="/2020/05/16/python/Python%E9%AB%98%E7%BA%A7%E7%BC%96%E7%A8%8B%E5%92%8C%E5%BC%82%E6%AD%A5IO%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B/WX20190519-100736@2x.png" alt></p>
<p><a href="https://docs.python.org/3.6/library/array.html" target="_blank" rel="noopener">https://docs.python.org/3.6/library/array.html</a></p>
<h4 id="列表推导式、生成器表达式、字典推导式、集合推导式"><a href="#列表推导式、生成器表达式、字典推导式、集合推导式" class="headerlink" title="列表推导式、生成器表达式、字典推导式、集合推导式"></a>列表推导式、生成器表达式、字典推导式、集合推导式</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 列表推导式的效率比较高</span></span><br><span class="line">old_list = [i <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">21</span>) <span class="keyword">if</span> i % <span class="number">2</span> == <span class="number">1</span>]</span><br><span class="line"></span><br><span class="line"><span class="comment"># 用列表推导式把列表嵌套列表变成一个列表</span></span><br><span class="line">a_list = [[<span class="number">1</span>,<span class="number">2</span>], [<span class="number">3</span>,<span class="number">4</span>], [<span class="number">5</span>,<span class="number">6</span>], [<span class="number">7</span>,<span class="number">8</span>]]</span><br><span class="line">b_list = [i <span class="keyword">for</span> j <span class="keyword">in</span> a_list <span class="keyword">for</span> i <span class="keyword">in</span> j]</span><br><span class="line">print(b_list)</span><br><span class="line">&gt;&gt;[<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>, <span class="number">6</span>, <span class="number">7</span>, <span class="number">8</span>]</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">hadle_item</span><span class="params">(item)</span>:</span></span><br><span class="line">  <span class="keyword">return</span> item * item</span><br><span class="line">old_list = [hadle_item(i) <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">21</span>) <span class="keyword">if</span> i % <span class="number">2</span> == <span class="number">1</span>]</span><br><span class="line"></span><br><span class="line"><span class="comment"># 生成器表达式</span></span><br><span class="line">old_gen = (i <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">21</span>) <span class="keyword">if</span> i % <span class="number">2</span> == <span class="number">1</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 字典推导式</span></span><br><span class="line">my_dict = &#123;<span class="string">"bobby1"</span>:<span class="number">22</span>, <span class="string">"bobby2"</span>: <span class="number">23</span>, <span class="string">"bobby3"</span>: <span class="number">25</span>&#125;</span><br><span class="line"><span class="comment"># 使用字典推导式把上面的字典key和value进行反转</span></span><br><span class="line">new_dict = &#123;value:key <span class="keyword">for</span> key,value <span class="keyword">in</span> my_dict.item()&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 集合推导式</span></span><br><span class="line"><span class="comment"># my_set = set(my_dict.keys()) 此方法也可实现，但是没有集合推导式灵活</span></span><br><span class="line">my_set = &#123;key <span class="keyword">for</span> key,value <span class="keyword">in</span> my_dict.item()&#125;</span><br></pre></td></tr></table></figure>



<h1 id="第六章-深入python的set和dict"><a href="#第六章-深入python的set和dict" class="headerlink" title="第六章 深入python的set和dict"></a>第六章 深入python的set和dict</h1><h4 id="dict的常用方法"><a href="#dict的常用方法" class="headerlink" title="dict的常用方法"></a>dict的常用方法</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">a = &#123;<span class="string">"bobby1"</span>: &#123;<span class="string">"company"</span>: <span class="string">"imooc"</span>&#125;,</span><br><span class="line">     <span class="string">"bobby2"</span>: &#123;<span class="string">"company"</span>: <span class="string">"imooc2"</span>&#125;</span><br><span class="line">     &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># clear清空字典里的全部数据</span></span><br><span class="line">a.clear()</span><br><span class="line"></span><br><span class="line"><span class="comment"># copy, 返回浅拷贝</span></span><br><span class="line">new_dict = a.copy()</span><br><span class="line">new_dict[<span class="string">"bobby1"</span>][<span class="string">"company"</span>] = <span class="string">"imooc3"</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># formkeys，向字典中添加数据，key是new_list中的各个元素，value是添加的默认值</span></span><br><span class="line">new_list = [<span class="string">"bobby1"</span>, <span class="string">"bobby2"</span>]</span><br><span class="line">new_dict = dict.fromkeys(new_list, &#123;<span class="string">"company"</span>: <span class="string">"imooc"</span>&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment"># setdefault,把key和value添加到字典中，并且返回的是value</span></span><br><span class="line">get_value = a.setdefault(<span class="string">"tom"</span>, <span class="string">"alibaba"</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># update，更新字典，可以以3中方式添加数据</span></span><br><span class="line">new_dict.update(&#123;<span class="string">"tom1"</span>: <span class="string">"1"</span>&#125;)</span><br><span class="line">new_dict.update(tom2=<span class="string">"2"</span>, tom3=<span class="string">"3"</span>)</span><br><span class="line">new_dict.update([(<span class="string">"tom4"</span>, <span class="string">"4"</span>),])</span><br><span class="line">new_dict.update(((<span class="string">"bobby"</span>, <span class="string">"imooc"</span>),))</span><br></pre></td></tr></table></figure>



<h4 id="dict的子类"><a href="#dict的子类" class="headerlink" title="dict的子类"></a>dict的子类</h4><p>UserDict: 使用dict的子类，可以继承UserDict，不要继承于dict</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> collections <span class="keyword">import</span> UserDict</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Mydict</span><span class="params">(UserDict)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__setitem__</span><span class="params">(self, key, value)</span>:</span></span><br><span class="line">        super().__setitem__(key, value * <span class="number">2</span>)</span><br><span class="line"></span><br><span class="line">my_dict = Mydict(one=<span class="number">1</span>)</span><br><span class="line"><span class="comment"># my_dict["one"] = 1</span></span><br><span class="line">print(my_dict)</span><br></pre></td></tr></table></figure>

<p>defaultdict：子类继承于defaultdict后，如果取值没有，那么就会执行对应的<code>__miss__</code>方法，默认的defaultdict如果取值没有，则会添加空字典进字典，并且返回空字典</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> collections <span class="keyword">import</span> defaultdict</span><br><span class="line"></span><br><span class="line">my_dict = defaultdict(dict)</span><br><span class="line">my_value = my_dict[<span class="string">"bobby"</span>]</span><br><span class="line">print(my_value)</span><br><span class="line">print(my_dict)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 执行结果</span></span><br><span class="line">&#123;&#125;</span><br><span class="line">defaultdict(&lt;class 'dict'&gt;, &#123;'bobby': &#123;&#125;&#125;)</span><br></pre></td></tr></table></figure>



<h4 id="set、fronzenset"><a href="#set、fronzenset" class="headerlink" title="set、fronzenset"></a>set、fronzenset</h4><p>set集合 fronzenset (不可变集合) 无序， 不重复</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">s = set(<span class="string">'abcdee'</span>)</span><br><span class="line">s = &#123;<span class="string">'a'</span>, <span class="string">'b'</span>, <span class="string">'c'</span>&#125;</span><br><span class="line"><span class="comment"># s = frozenset("abcde") #frozenset可以作为dict的key，因为frozenst是不可变的</span></span><br><span class="line"><span class="comment"># print(s)</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># set性能很高</span></span><br><span class="line"><span class="comment"># | &amp; -  #集合运算</span></span><br><span class="line"><span class="comment"># 向set添加数据</span></span><br><span class="line">another_set = set(<span class="string">"cef"</span>)</span><br><span class="line">re_set = s.difference(another_set)</span><br><span class="line">re_set = s - another_set</span><br><span class="line">re_set = s &amp; another_set</span><br><span class="line">re_set = s | another_set</span><br><span class="line">print(re_set)</span><br><span class="line"></span><br><span class="line">print(s.issubset(re_set))  <span class="comment"># 判断re_set是否是s的子集</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> <span class="string">"c"</span> <span class="keyword">in</span> re_set:</span><br><span class="line">    <span class="keyword">print</span> (<span class="string">"i am in set"</span>)</span><br></pre></td></tr></table></figure>



<h4 id="dict和set的实现原理"><a href="#dict和set的实现原理" class="headerlink" title="dict和set的实现原理"></a>dict和set的实现原理</h4><ul>
<li><p>dict查找的性能远远大于list    </p>
</li>
<li><p>在list中随着list数据的增大 查找时间会增大    </p>
</li>
<li><p>在dict中查找元素不会随着dict的增大而增大    </p>
</li>
</ul>
<ol>
<li>dict的key或者set的值 都必须是可以hash的，不可变对象 都是可hash的， str， fronzenset， tuple，自己实现的类<code>__hash__</code></li>
<li>dict的内存花销大，但是查询速度快， 自定义的对象 或者python内部的对象都是用dict包装的</li>
<li>dict的存储顺序和元素添加顺序有关</li>
<li>添加数据有可能改变已有数据的顺序</li>
</ol>
<p><img src="/2020/05/16/python/Python%E9%AB%98%E7%BA%A7%E7%BC%96%E7%A8%8B%E5%92%8C%E5%BC%82%E6%AD%A5IO%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B/WX20190519-164439@2x.png" alt></p>
<p><img src="/2020/05/16/python/Python%E9%AB%98%E7%BA%A7%E7%BC%96%E7%A8%8B%E5%92%8C%E5%BC%82%E6%AD%A5IO%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B/WX20190519-164704@2x.png" alt></p>
<h1 id="第七章-对象引用、可变性和垃圾回收"><a href="#第七章-对象引用、可变性和垃圾回收" class="headerlink" title="第七章 对象引用、可变性和垃圾回收"></a>第七章 对象引用、可变性和垃圾回收</h1><h4 id="一个经典的错误"><a href="#一个经典的错误" class="headerlink" title="一个经典的错误"></a>一个经典的错误</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add</span><span class="params">(a, b)</span>:</span></span><br><span class="line">    a += b</span><br><span class="line">    <span class="keyword">return</span> a</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Company</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, name, staffs=[])</span>:</span></span><br><span class="line">        self.name = name</span><br><span class="line">        self.staffs = staffs</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">add</span><span class="params">(self, staff_name)</span>:</span></span><br><span class="line">        self.staffs.append(staff_name)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">remove</span><span class="params">(self, staff_name)</span>:</span></span><br><span class="line">        self.staffs.remove(staff_name)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">"__main__"</span>:</span><br><span class="line">    com1 = Company(<span class="string">"com1"</span>, [<span class="string">"bobby1"</span>, <span class="string">"bobby2"</span>])</span><br><span class="line">    com1.add(<span class="string">"bobby3"</span>)</span><br><span class="line">    com1.remove(<span class="string">"bobby1"</span>)</span><br><span class="line">    print(com1.staffs)</span><br><span class="line"></span><br><span class="line">    com2 = Company(<span class="string">"com2"</span>)</span><br><span class="line">    com2.add(<span class="string">"bobby"</span>)</span><br><span class="line">    print(com2.staffs)</span><br><span class="line"></span><br><span class="line">    print(Company.__init__.__defaults__)</span><br><span class="line"></span><br><span class="line">    com3 = Company(<span class="string">"com3"</span>)</span><br><span class="line">    com3.add(<span class="string">"bobby5"</span>)</span><br><span class="line">    <span class="comment"># 因为初始化时用，staffs=[]，在内存中是同一个地址下的同一个列表，所以com2,com3的staffs是同一个。</span></span><br><span class="line">    print(com2.staffs)</span><br><span class="line">    print(com3.staffs)</span><br><span class="line">    print(com2.staffs <span class="keyword">is</span> com3.staffs)</span><br><span class="line"></span><br><span class="line">    a = <span class="number">1</span></span><br><span class="line">    b = <span class="number">2</span></span><br><span class="line">    c = add(a, b)</span><br><span class="line">    print(c)</span><br><span class="line">    print(a, b)</span><br><span class="line"></span><br><span class="line">    a = [<span class="number">1</span>, <span class="number">2</span>]</span><br><span class="line">    b = [<span class="number">3</span>, <span class="number">4</span>]</span><br><span class="line">    c = add(a, b)</span><br><span class="line">    print(c)</span><br><span class="line">    print(a, b)</span><br><span class="line"></span><br><span class="line">    a = (<span class="number">1</span>, <span class="number">2</span>)</span><br><span class="line">    b = (<span class="number">3</span>, <span class="number">4</span>)</span><br><span class="line">    c = add(a, b)</span><br><span class="line">    print(c)</span><br><span class="line">    print(a, b)</span><br></pre></td></tr></table></figure>



<h1 id="第八章-元类编程"><a href="#第八章-元类编程" class="headerlink" title="第八章 元类编程"></a>第八章 元类编程</h1><h4 id="property属性"><a href="#property属性" class="headerlink" title="property属性"></a>property属性</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> datetime <span class="keyword">import</span> date, datetime</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">User</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, name, birthday)</span>:</span></span><br><span class="line">        self.name = name</span><br><span class="line">        self.birthday = birthday</span><br><span class="line">        self._age = <span class="number">0</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># def get_age(self):</span></span><br><span class="line">    <span class="comment">#     return datetime.now().year - self.birthday.year</span></span><br><span class="line"></span><br><span class="line"><span class="meta">    @property</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">age</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> datetime.now().year - self.birthday.year</span><br><span class="line"></span><br><span class="line"><span class="meta">    @age.setter</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">age</span><span class="params">(self, value)</span>:</span></span><br><span class="line">        self._age = value</span><br><span class="line"></span><br><span class="line"><span class="meta">    @age.deleter</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">age</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">del</span> self._age</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">"__main__"</span>:</span><br><span class="line">    user = User(<span class="string">"bobby"</span>, date(year=<span class="number">1987</span>, month=<span class="number">1</span>, day=<span class="number">1</span>))</span><br><span class="line">    user.age = <span class="number">30</span></span><br><span class="line">    print(user._age)</span><br><span class="line">    print(user.age)</span><br></pre></td></tr></table></figure>



<h4 id="属性描述符"><a href="#属性描述符" class="headerlink" title="属性描述符"></a>属性描述符</h4><p>获取的属性如果是一个变量，那么用getattr函数就比较方便，例如：getattr(user, name)</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">'''</span></span><br><span class="line"><span class="string">如果user是某个类的实例，那么user.age（以及等价的getattr(user,’age’)）</span></span><br><span class="line"><span class="string">首先调用__getattribute__。</span></span><br><span class="line"><span class="string">如果类定义了__getattr__方法，那么在__getattribute__抛出 AttributeError 的时候就会调用到__getattr__，而对于描述符(__get__）的调用，则是发生在__getattribute__内部的。</span></span><br><span class="line"><span class="string">user = User(), 那么user.age 顺序如下：</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">（1）如果“age”是出现在User或其基类的__dict__中， 且age是data descriptor(数据属性描述符)， 那么调用其__get__方法, 否则</span></span><br><span class="line"><span class="string">（2）如果“age”出现在user的__dict__中， 那么直接返回 obj.__dict__[‘age’]， 否则</span></span><br><span class="line"><span class="string">（3）如果“age”出现在User或其基类的__dict__中</span></span><br><span class="line"><span class="string">	（3.1）如果age是non-data descriptor（非数据属性描述符），那么调用其__get__方法， 否则</span></span><br><span class="line"><span class="string">	（3.2）返回 __dict__[‘age’]</span></span><br><span class="line"><span class="string">（4）如果User有__getattr__方法，调用__getattr__方法，否则</span></span><br><span class="line"><span class="string">（5）抛出AttributeError</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">只要实现__get__、set、__delete__方法中的一个就可以认为是属性描述符；</span></span><br><span class="line"><span class="string">只实现__get__方法的对象是非数据属性描述符，在初始化之后它们只能被读取；</span></span><br><span class="line"><span class="string">同时实现__get__和__set__的对象是数据属性描述符，这种属性是可读写的。</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">'''</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">IntField</span>:</span></span><br><span class="line">    <span class="comment">#数据属性描述符</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__get__</span><span class="params">(self, instance, owner)</span>:</span>  <span class="comment"># 获取属性</span></span><br><span class="line">        <span class="keyword">return</span> self.value</span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__set__</span><span class="params">(self, instance, value)</span>:</span>  <span class="comment"># 设置属性</span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> isinstance(value, numbers.Integral):</span><br><span class="line">            <span class="keyword">raise</span> ValueError(<span class="string">"int value need"</span>)</span><br><span class="line">        <span class="keyword">if</span> value &lt; <span class="number">0</span>:</span><br><span class="line">            <span class="keyword">raise</span> ValueError(<span class="string">"positive value need"</span>)</span><br><span class="line">        self.value = value</span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__delete__</span><span class="params">(self, instance)</span>:</span>  <span class="comment"># 删除属性</span></span><br><span class="line">        <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">NonDataIntField</span>:</span></span><br><span class="line">    <span class="comment">#非数据属性描述符</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__get__</span><span class="params">(self, instance, owner)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> self.value</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">User</span>:</span></span><br><span class="line">    age = IntField()</span><br><span class="line">    <span class="comment"># age = NonDataIntField()</span></span><br></pre></td></tr></table></figure>



<h4 id="自定义元类"><a href="#自定义元类" class="headerlink" title="自定义元类"></a>自定义元类</h4><p>什么是元类， 元类是创建类的类 对象&lt;-class(对象)&lt;-type</p>
<p>创建类的方法有三种：</p>
<p>方法一：</p>
<p>通过函数动态创建</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">create_class</span><span class="params">(name)</span>:</span></span><br><span class="line">    <span class="keyword">if</span> name == <span class="string">"user"</span>:</span><br><span class="line">        <span class="class"><span class="keyword">class</span> <span class="title">User</span>:</span></span><br><span class="line">            <span class="function"><span class="keyword">def</span> <span class="title">__str__</span><span class="params">(self)</span>:</span></span><br><span class="line">                <span class="keyword">return</span> <span class="string">"user"</span></span><br><span class="line">        <span class="keyword">return</span> User</span><br><span class="line">    <span class="keyword">elif</span> name == <span class="string">"company"</span>:</span><br><span class="line">        <span class="class"><span class="keyword">class</span> <span class="title">Company</span>:</span></span><br><span class="line">            <span class="function"><span class="keyword">def</span> <span class="title">__str__</span><span class="params">(self)</span>:</span></span><br><span class="line">                <span class="keyword">return</span> <span class="string">"company"</span></span><br><span class="line">        <span class="keyword">return</span> Company</span><br></pre></td></tr></table></figure>

<p>方法二：</p>
<p>通过type创建，类也是对象，type是创建类的类</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">say</span><span class="params">(self)</span>:</span></span><br><span class="line">    <span class="keyword">return</span> <span class="string">"i am user"</span></span><br><span class="line">    <span class="comment"># return self.name</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">BaseClass</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">answer</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> <span class="string">"i am baseclass"</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#type动态创建类</span></span><br><span class="line"><span class="comment"># User = type("User", (), &#123;&#125;)</span></span><br><span class="line">User = type(<span class="string">"User"</span>, (BaseClass, ), &#123;<span class="string">"name"</span>:<span class="string">"user"</span>, <span class="string">"say"</span>:say&#125;)</span><br></pre></td></tr></table></figure>

<p>方法三：</p>
<p>metaclass</p>
<p>python中的类的实例化过程：会首先寻找metaclass，通过metaclass里的<code>__new__</code>方法实例化一个实例对象，如果自己的metaclass找不到，会向上一级寻找父类的metaclass</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MetaClass</span><span class="params">(type)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__new__</span><span class="params">(cls, *args, **kwargs)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> super().__new__(cls, *args, **kwargs)</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">User</span><span class="params">(metaclass=MetaClass)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, name)</span>:</span></span><br><span class="line">        self.name = name</span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__str__</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> <span class="string">"user"</span></span><br></pre></td></tr></table></figure>



<h4 id="通过元类实现ORM"><a href="#通过元类实现ORM" class="headerlink" title="通过元类实现ORM"></a>通过元类实现ORM</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 需求</span></span><br><span class="line"><span class="keyword">import</span> numbers</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Field</span>:</span></span><br><span class="line">    <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">IntField</span><span class="params">(Field)</span>:</span></span><br><span class="line">    <span class="comment"># 数据描述符</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, db_column, min_value=None, max_value=None)</span>:</span></span><br><span class="line">        self._value = <span class="literal">None</span></span><br><span class="line">        self.min_value = min_value</span><br><span class="line">        self.max_value = max_value</span><br><span class="line">        self.db_column = db_column</span><br><span class="line">        <span class="keyword">if</span> min_value <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>:</span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">not</span> isinstance(min_value, numbers.Integral):</span><br><span class="line">                <span class="keyword">raise</span> ValueError(<span class="string">"min_value must be int"</span>)</span><br><span class="line">            <span class="keyword">elif</span> min_value &lt; <span class="number">0</span>:</span><br><span class="line">                <span class="keyword">raise</span> ValueError(<span class="string">"min_value must be positive int"</span>)</span><br><span class="line">        <span class="keyword">if</span> max_value <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>:</span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">not</span> isinstance(max_value, numbers.Integral):</span><br><span class="line">                <span class="keyword">raise</span> ValueError(<span class="string">"max_value must be int"</span>)</span><br><span class="line">            <span class="keyword">elif</span> max_value &lt; <span class="number">0</span>:</span><br><span class="line">                <span class="keyword">raise</span> ValueError(<span class="string">"max_value must be positive int"</span>)</span><br><span class="line">        <span class="keyword">if</span> min_value <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span> <span class="keyword">and</span> max_value <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>:</span><br><span class="line">            <span class="keyword">if</span> min_value &gt; max_value:</span><br><span class="line">                <span class="keyword">raise</span> ValueError(<span class="string">"min_value must be smaller than max_value"</span>)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__get__</span><span class="params">(self, instance, owner)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> self._value</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__set__</span><span class="params">(self, instance, value)</span>:</span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> isinstance(value, numbers.Integral):</span><br><span class="line">            <span class="keyword">raise</span> ValueError(<span class="string">"int value need"</span>)</span><br><span class="line">        <span class="keyword">if</span> value &lt; self.min_value <span class="keyword">or</span> value &gt; self.max_value:</span><br><span class="line">            <span class="keyword">raise</span> ValueError(<span class="string">"value must between min_value and max_value"</span>)</span><br><span class="line">        self._value = value</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">CharField</span><span class="params">(Field)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, db_column, max_length=None)</span>:</span></span><br><span class="line">        self._value = <span class="literal">None</span></span><br><span class="line">        self.db_column = db_column</span><br><span class="line">        <span class="keyword">if</span> max_length <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">            <span class="keyword">raise</span> ValueError(<span class="string">"you must spcify max_lenth for charfiled"</span>)</span><br><span class="line">        self.max_length = max_length</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__get__</span><span class="params">(self, instance, owner)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> self._value</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__set__</span><span class="params">(self, instance, value)</span>:</span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> isinstance(value, str):</span><br><span class="line">            <span class="keyword">raise</span> ValueError(<span class="string">"string value need"</span>)</span><br><span class="line">        <span class="keyword">if</span> len(value) &gt; self.max_length:</span><br><span class="line">            <span class="keyword">raise</span> ValueError(<span class="string">"value len excess len of max_length"</span>)</span><br><span class="line">        self._value = value</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ModelMetaClass</span><span class="params">(type)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__new__</span><span class="params">(cls, name, bases, attrs, **kwargs)</span>:</span></span><br><span class="line">        <span class="keyword">if</span> name == <span class="string">"BaseModel"</span>:</span><br><span class="line">            <span class="keyword">return</span> super().__new__(cls, name, bases, attrs, **kwargs)</span><br><span class="line">        fields = &#123;&#125;</span><br><span class="line">        <span class="keyword">for</span> key, value <span class="keyword">in</span> attrs.items():</span><br><span class="line">            <span class="keyword">if</span> isinstance(value, Field):</span><br><span class="line">                fields[key] = value</span><br><span class="line">        attrs_meta = attrs.get(<span class="string">"Meta"</span>, <span class="literal">None</span>)</span><br><span class="line">        _meta = &#123;&#125;</span><br><span class="line">        db_table = name.lower()</span><br><span class="line">        <span class="keyword">if</span> attrs_meta <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>:</span><br><span class="line">            table = getattr(attrs_meta, <span class="string">"db_table"</span>, <span class="literal">None</span>)</span><br><span class="line">            <span class="keyword">if</span> table <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>:</span><br><span class="line">                db_table = table</span><br><span class="line">        _meta[<span class="string">"db_table"</span>] = db_table</span><br><span class="line">        attrs[<span class="string">"_meta"</span>] = _meta</span><br><span class="line">        attrs[<span class="string">"fields"</span>] = fields</span><br><span class="line">        <span class="keyword">del</span> attrs[<span class="string">"Meta"</span>]</span><br><span class="line">        <span class="keyword">return</span> super().__new__(cls, name, bases, attrs, **kwargs)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">BaseModel</span><span class="params">(metaclass=ModelMetaClass)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, *args, **kwargs)</span>:</span></span><br><span class="line">        <span class="keyword">for</span> key, value <span class="keyword">in</span> kwargs.items():</span><br><span class="line">            setattr(self, key, value)</span><br><span class="line">        <span class="keyword">return</span> super().__init__()</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">save</span><span class="params">(self)</span>:</span></span><br><span class="line">        fields = []</span><br><span class="line">        values = []</span><br><span class="line">        <span class="keyword">for</span> key, value <span class="keyword">in</span> self.fields.items():</span><br><span class="line">            db_column = value.db_column</span><br><span class="line">            <span class="keyword">if</span> db_column <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">                db_column = key.lower()</span><br><span class="line">            fields.append(db_column)</span><br><span class="line">            value = getattr(self, key)</span><br><span class="line">            values.append(str(value))</span><br><span class="line"></span><br><span class="line">        sql = <span class="string">"insert &#123;db_table&#125;(&#123;fields&#125;) value(&#123;values&#125;)"</span>.format(db_table=self._meta[<span class="string">"db_table"</span>],</span><br><span class="line">                                                                   fields=<span class="string">","</span>.join(fields), values=<span class="string">","</span>.join(values))</span><br><span class="line">        <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">User</span><span class="params">(BaseModel)</span>:</span></span><br><span class="line">    name = CharField(db_column=<span class="string">"name"</span>, max_length=<span class="number">10</span>)</span><br><span class="line">    age = IntField(db_column=<span class="string">"age"</span>, min_value=<span class="number">1</span>, max_value=<span class="number">100</span>)</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Meta</span>:</span></span><br><span class="line">        db_table = <span class="string">"user"</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">"__main__"</span>:</span><br><span class="line">    user = User(name=<span class="string">"bobby"</span>, age=<span class="number">28</span>)</span><br><span class="line">    <span class="comment"># user.name = "bobby"</span></span><br><span class="line">    <span class="comment"># user.age = 28</span></span><br><span class="line">    user.save()</span><br></pre></td></tr></table></figure>



<h1 id="第九章-迭代器和生成器"><a href="#第九章-迭代器和生成器" class="headerlink" title="第九章 迭代器和生成器"></a>第九章 迭代器和生成器</h1><h4 id="可迭代对象和迭代器"><a href="#可迭代对象和迭代器" class="headerlink" title="可迭代对象和迭代器"></a>可迭代对象和迭代器</h4><p>list是可迭代对象，而不是迭代器</p>
<p>实现<code>__item__</code>方法即是可迭代对象，而<code>__item__</code>方法必须要return一个迭代器</p>
<p>实现<code>__item__</code>方法和<code>__next__</code>方法即是迭代器，而<code>__item__</code>方法要return self，<code>__next__</code>方法实现遍历。</p>
<p>在创建一个可迭代对象时尽量不要定义<code>__next__</code>方法，要单独创建一个迭代器，然后在这个可迭代对象的<code>__item__</code>方法里return这个迭代器即可，分开维护比较好。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> collections.abc <span class="keyword">import</span> Iterator</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Company</span><span class="params">(object)</span>:</span>  <span class="comment"># 是可迭代对象</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, employee_list)</span>:</span></span><br><span class="line">        self.employee = employee_list</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__iter__</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> MyIterator(self.employee)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyIterator</span><span class="params">(Iterator)</span>:</span>  <span class="comment"># 是迭代器，因为继承了Iterator，所以无需再写__item__方法</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, employee_list)</span>:</span></span><br><span class="line">        self.iter_list = employee_list</span><br><span class="line">        self.index = <span class="number">0</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__next__</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="comment">#真正返回迭代值的逻辑</span></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            word = self.iter_list[self.index]</span><br><span class="line">        <span class="keyword">except</span> IndexError:</span><br><span class="line">            <span class="keyword">raise</span> StopIteration</span><br><span class="line">        self.index += <span class="number">1</span></span><br><span class="line">        <span class="keyword">return</span> word</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">"__main__"</span>:</span><br><span class="line">    company = Company([<span class="string">"tom"</span>, <span class="string">"bob"</span>, <span class="string">"jane"</span>])</span><br><span class="line">    my_itor = iter(company)</span><br><span class="line">    <span class="comment"># while True:</span></span><br><span class="line">    <span class="comment">#     try:</span></span><br><span class="line">    <span class="comment">#         print (next(my_itor))</span></span><br><span class="line">    <span class="comment">#     except StopIteration:</span></span><br><span class="line">    <span class="comment">#         pass</span></span><br><span class="line">    <span class="keyword">for</span> item <span class="keyword">in</span> company:</span><br><span class="line">        <span class="keyword">print</span> (item)</span><br></pre></td></tr></table></figure>



<h4 id="生成器"><a href="#生成器" class="headerlink" title="生成器"></a>生成器</h4><p>调用生成器函数，返回的是一个生成器的对象</p>
<p>生成器的应用：大文件读取</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 500G, 特殊 一行</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">myreadlines</span><span class="params">(f, newline)</span>:</span></span><br><span class="line">    buf = <span class="string">""</span></span><br><span class="line">    <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">        <span class="keyword">while</span> newline <span class="keyword">in</span> buf:</span><br><span class="line">            pos = buf.index(newline)</span><br><span class="line">            <span class="keyword">yield</span> buf[:pos]</span><br><span class="line">            buf = buf[pos + len(newline):]</span><br><span class="line">        chunk = f.read(<span class="number">4096</span>)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> chunk:</span><br><span class="line">            <span class="comment"># 说明已经读到了文件结尾</span></span><br><span class="line">            <span class="keyword">yield</span> buf</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">        buf += chunk</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">with</span> open(<span class="string">"input.txt"</span>) <span class="keyword">as</span> f:</span><br><span class="line">    <span class="keyword">for</span> line <span class="keyword">in</span> myreadlines(f, <span class="string">"&#123;|&#125;"</span>):</span><br><span class="line">        print(line)</span><br></pre></td></tr></table></figure>



<h1 id="第十章-python-socket编程"><a href="#第十章-python-socket编程" class="headerlink" title="第十章 python socket编程"></a>第十章 python socket编程</h1><h4 id="客户端"><a href="#客户端" class="headerlink" title="客户端"></a>客户端</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> socket</span><br><span class="line"></span><br><span class="line">client = socket.socket(socket.AF_INET, socket.SOCK_STREAM)</span><br><span class="line">client.connect((<span class="string">'127.0.0.1'</span>, <span class="number">8000</span>))</span><br><span class="line">client.send(<span class="string">"bobby"</span>.encode(<span class="string">"utf8"</span>))</span><br><span class="line">data = client.recv(<span class="number">1024</span>)</span><br><span class="line">print(data.decode(<span class="string">"utf8"</span>))</span><br><span class="line">client.close()</span><br></pre></td></tr></table></figure>



<h4 id="服务端"><a href="#服务端" class="headerlink" title="服务端"></a>服务端</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> socket</span><br><span class="line"><span class="keyword">import</span> threading</span><br><span class="line"></span><br><span class="line">server = socket.socket(socket.AF_INET, socket.SOCK_STREAM)</span><br><span class="line">server.bind((<span class="string">'0.0.0.0'</span>, <span class="number">8000</span>))</span><br><span class="line">server.listen()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">handle_sock</span><span class="params">(sock, addr)</span>:</span></span><br><span class="line">    <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">        data = sock.recv(<span class="number">1024</span>)</span><br><span class="line">        print(data.decode(<span class="string">"utf8"</span>))</span><br><span class="line">        re_data = input()</span><br><span class="line">        sock.send(re_data.encode(<span class="string">"utf8"</span>))</span><br><span class="line"></span><br><span class="line"><span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">    sock, addr = server.accept()</span><br><span class="line">    client_thread = threading.Thread(target=handle_sock, args=(sock, addr))</span><br><span class="line">    client_thread.start()</span><br></pre></td></tr></table></figure>



<h1 id="第十一章-多线程、多进程和线程池编程"><a href="#第十一章-多线程、多进程和线程池编程" class="headerlink" title="第十一章 多线程、多进程和线程池编程"></a>第十一章 多线程、多进程和线程池编程</h1><h4 id="GIL锁-全局解释器锁"><a href="#GIL锁-全局解释器锁" class="headerlink" title="GIL锁(全局解释器锁)"></a>GIL锁(全局解释器锁)</h4><ol>
<li>Python语言和GIL没有半毛钱关系。仅仅是由于历史原因在Cpython虚拟机(解释器)，难以移除GIL。</li>
<li>GIL：全局解释器锁。每个线程在执行的过程都需要先获取GIL，保证同一时刻只有一个线程可以执行代码。</li>
<li>线程释放GIL锁的情况： 在IO操作等可能会引起阻塞的system call之前,可以暂时释放GIL,但在执行完毕后,必须重新获取GIL Python 3.x使用计时器（执行时间达到阈值后，当前线程释放GIL）或Python 2.x，tickets计数达到100</li>
<li>Python使用多进程是可以利用多核的CPU资源的。</li>
<li>多线程爬取比单线程性能有提升，因为遇到IO阻塞会自动释放GIL锁</li>
</ol>
<h4 id="多线程编程"><a href="#多线程编程" class="headerlink" title="多线程编程"></a>多线程编程</h4><p>方法一：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">import</span> threading</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_detail_html</span><span class="params">(url)</span>:</span></span><br><span class="line">    print(<span class="string">"get detail html started"</span>)</span><br><span class="line">    time.sleep(<span class="number">2</span>)</span><br><span class="line">    print(<span class="string">"get detail html end"</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_detail_url</span><span class="params">(url)</span>:</span></span><br><span class="line">    print(<span class="string">"get detail url started"</span>)</span><br><span class="line">    time.sleep(<span class="number">4</span>)</span><br><span class="line">    print(<span class="string">"get detail url end"</span>)</span><br><span class="line">    </span><br><span class="line"><span class="keyword">if</span>  __name__ == <span class="string">"__main__"</span>:</span><br><span class="line">    thread1 = GetDetailHtml(<span class="string">"get_detail_html"</span>)</span><br><span class="line">    thread2 = GetDetailUrl(<span class="string">"get_detail_url"</span>)</span><br><span class="line">    <span class="comment"># thread1.setDaemon()  # 设置为守护线程，即主线程结束，则子线程即结束</span></span><br><span class="line">    <span class="comment"># thread2.setDaemon()</span></span><br><span class="line">    start_time = time.time()</span><br><span class="line">    thread1.start()</span><br><span class="line">    thread2.start()</span><br><span class="line">    thread1.join()  <span class="comment"># 子线程结束后再运行主线程</span></span><br><span class="line">    thread2.join()</span><br><span class="line">    <span class="comment">#当主线程退出的时候， 子线程kill掉</span></span><br><span class="line">    <span class="keyword">print</span> (<span class="string">"last time: &#123;&#125;"</span>.format(time.time()-start_time))</span><br></pre></td></tr></table></figure>



<p>方法二：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">GetDetailHtml</span><span class="params">(threading.Thread)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, name)</span>:</span></span><br><span class="line">        super().__init__(name=name)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">run</span><span class="params">(self)</span>:</span></span><br><span class="line">        print(<span class="string">"get detail html started"</span>)</span><br><span class="line">        time.sleep(<span class="number">2</span>)</span><br><span class="line">        print(<span class="string">"get detail html end"</span>)</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">GetDetailUrl</span><span class="params">(threading.Thread)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, name)</span>:</span></span><br><span class="line">        super().__init__(name=name)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">run</span><span class="params">(self)</span>:</span></span><br><span class="line">        print(<span class="string">"get detail url started"</span>)</span><br><span class="line">        time.sleep(<span class="number">4</span>)</span><br><span class="line">        print(<span class="string">"get detail url end"</span>)</span><br><span class="line">        </span><br><span class="line"><span class="keyword">if</span>  __name__ == <span class="string">"__main__"</span>:</span><br><span class="line">    thread1 = GetDetailHtml(<span class="string">"get_detail_html"</span>)</span><br><span class="line">    thread2 = GetDetailUrl(<span class="string">"get_detail_url"</span>)</span><br><span class="line">    thread1.start()</span><br><span class="line">    thread2.start()</span><br></pre></td></tr></table></figure>



<h4 id="线程间通信-共享变量和Queue"><a href="#线程间通信-共享变量和Queue" class="headerlink" title="线程间通信-共享变量和Queue"></a>线程间通信-共享变量和Queue</h4><p>从其他文件导入全局变量时尽量使用：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> capter <span class="keyword">import</span> variables</span><br><span class="line">variables.detail_url_list</span><br></pre></td></tr></table></figure>

<p>而不要使用：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> capter.variables <span class="keyword">import</span> detail_url_list</span><br></pre></td></tr></table></figure>

<p>Queue用例：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> queue <span class="keyword">import</span> Queue</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">import</span> threading</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_detail_html</span><span class="params">(queue)</span>:</span></span><br><span class="line">    <span class="comment">#爬取文章详情页</span></span><br><span class="line">    <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">        url = queue.get()</span><br><span class="line">        <span class="comment"># for url in detail_url_list:</span></span><br><span class="line">        print(<span class="string">"get detail html started"</span>)</span><br><span class="line">        time.sleep(<span class="number">2</span>)</span><br><span class="line">        print(<span class="string">"get detail html end"</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_detail_url</span><span class="params">(queue)</span>:</span></span><br><span class="line">    <span class="comment"># 爬取文章列表页</span></span><br><span class="line">    <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">        print(<span class="string">"get detail url started"</span>)</span><br><span class="line">        time.sleep(<span class="number">4</span>)</span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">20</span>):</span><br><span class="line">            queue.put(<span class="string">"http://projectsedu.com/&#123;id&#125;"</span>.format(id=i))</span><br><span class="line">        print(<span class="string">"get detail url end"</span>)</span><br><span class="line">        </span><br><span class="line"><span class="keyword">if</span>  __name__ == <span class="string">"__main__"</span>:</span><br><span class="line">	detail_url_queue = Queue(maxsize=<span class="number">1000</span>)</span><br><span class="line">	thread_detail_url = threading.Thread(target=get_detail_url, args=		(detail_url_queue,))</span><br><span class="line">  html_thread = threading.Thread(target=get_detail_html, args=(detail_url_queue,))</span><br><span class="line">  thread_detail_url.start()</span><br><span class="line">  html_thread.start()</span><br><span class="line"></span><br><span class="line">  <span class="comment"># 以下两个是在不同地方成对使用，detail_url_queue.join()是从queue的角度阻塞主线程，当我们想要取消阻塞时，即达到我们想要的某个条件时，调用detail_url_queue.task_done()即可取消阻塞</span></span><br><span class="line">	detail_url_queue.task_done()</span><br><span class="line">	detail_url_queue.join()</span><br></pre></td></tr></table></figure>



<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#通过queue的方式进行线程间同步</span></span><br><span class="line"><span class="keyword">from</span> queue <span class="keyword">import</span> Queue</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">import</span> threading</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_detail_html</span><span class="params">(queue)</span>:</span></span><br><span class="line">    <span class="comment">#爬取文章详情页</span></span><br><span class="line">    <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">        url = queue.get()</span><br><span class="line">        <span class="comment"># for url in detail_url_list:</span></span><br><span class="line">        print(<span class="string">"get detail html started"</span>)</span><br><span class="line">        time.sleep(<span class="number">2</span>)</span><br><span class="line">        print(<span class="string">"get detail html end"</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_detail_url</span><span class="params">(queue)</span>:</span></span><br><span class="line">    <span class="comment"># 爬取文章列表页</span></span><br><span class="line">    <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">        print(<span class="string">"get detail url started"</span>)</span><br><span class="line">        time.sleep(<span class="number">4</span>)</span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">20</span>):</span><br><span class="line">            queue.put(<span class="string">"http://projectsedu.com/&#123;id&#125;"</span>.format(id=i))</span><br><span class="line">        print(<span class="string">"get detail url end"</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#1. 线程通信方式- 共享变量</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>  __name__ == <span class="string">"__main__"</span>:</span><br><span class="line">    detail_url_queue = Queue(maxsize=<span class="number">1000</span>)</span><br><span class="line">    thread_detail_url = threading.Thread(target=get_detail_url, args=(detail_url_queue,))</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">10</span>):</span><br><span class="line">        html_thread = threading.Thread(target=get_detail_html, args=(detail_url_queue,))</span><br><span class="line">        html_thread.start()</span><br><span class="line">    <span class="comment"># # thread2 = GetDetailUrl("get_detail_url")</span></span><br><span class="line">    start_time = time.time()</span><br><span class="line">    <span class="comment"># thread_detail_url.start()</span></span><br><span class="line">    <span class="comment"># thread_detail_url1.start()</span></span><br><span class="line">    <span class="comment">#</span></span><br><span class="line">    <span class="comment"># thread1.join()</span></span><br><span class="line">    <span class="comment"># thread2.join()</span></span><br><span class="line">    detail_url_queue.task_done()</span><br><span class="line">    detail_url_queue.join()</span><br><span class="line"></span><br><span class="line">    <span class="comment">#当主线程退出的时候， 子线程kill掉</span></span><br><span class="line">    <span class="keyword">print</span> (<span class="string">"last time: &#123;&#125;"</span>.format(time.time()-start_time))</span><br></pre></td></tr></table></figure>



<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 优先级队列(后插入的先取出)</span></span><br><span class="line"><span class="keyword">from</span> queue <span class="keyword">import</span> PriorityQueue</span><br></pre></td></tr></table></figure>



<h4 id="线程同步-Lock、RLock"><a href="#线程同步-Lock、RLock" class="headerlink" title="线程同步 - Lock、RLock"></a>线程同步 - Lock、RLock</h4><p>Lock锁</p>
<p>因为上锁和解锁需要时间，所以锁会影响性能</p>
<p>可能会出现死锁</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> threading <span class="keyword">import</span> Lock </span><br><span class="line"></span><br><span class="line">total = <span class="number">0</span></span><br><span class="line">lock = Lock()</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="comment">#1. dosomething1</span></span><br><span class="line">    <span class="comment">#2. io操作</span></span><br><span class="line">    <span class="comment"># 1. dosomething3</span></span><br><span class="line">    <span class="keyword">global</span> lock</span><br><span class="line">    <span class="keyword">global</span> total</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">1000000</span>):</span><br><span class="line">        lock.acquire()</span><br><span class="line">        total += <span class="number">1</span></span><br><span class="line">        lock.release()</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">desc</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="keyword">global</span> total</span><br><span class="line">    <span class="keyword">global</span> lock</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">1000000</span>):</span><br><span class="line">        lock.acquire()</span><br><span class="line">        total -= <span class="number">1</span></span><br><span class="line">        lock.release()</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> threading</span><br><span class="line">thread1 = threading.Thread(target=add)</span><br><span class="line">thread2 = threading.Thread(target=desc)</span><br><span class="line">thread1.start()</span><br><span class="line">thread2.start()</span><br><span class="line">thread1.join()</span><br><span class="line">thread2.join()</span><br><span class="line">print(total)</span><br><span class="line"></span><br><span class="line"><span class="comment">#1. 用锁会影响性能</span></span><br><span class="line"><span class="comment">#2. 锁会引起死锁</span></span><br></pre></td></tr></table></figure>

<p>Rlock</p>
<p>lock.acquire()在同一个线程内不能连续出现，否则会出现死锁,即：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="comment">#1. dosomething1</span></span><br><span class="line">    <span class="comment">#2. io操作</span></span><br><span class="line">    <span class="comment"># 1. dosomething3</span></span><br><span class="line">    <span class="keyword">global</span> lock</span><br><span class="line">    <span class="keyword">global</span> total</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">1000000</span>):</span><br><span class="line">        lock.acquire()</span><br><span class="line">        do_someing()</span><br><span class="line">        total += <span class="number">1</span></span><br><span class="line">        lock.release()</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">do_someing</span><span class="params">()</span></span></span><br><span class="line"><span class="function">		<span class="title">lock</span>.<span class="title">acquire</span><span class="params">()</span></span></span><br><span class="line">		total += 2</span><br><span class="line">		lock.release()</span><br></pre></td></tr></table></figure>

<p>此种问题可用Rlock解决，注意，有多少lock.acquire()就要有多少lock.release()</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> threading <span class="keyword">import</span> RLock</span><br><span class="line"></span><br><span class="line">total = <span class="number">0</span></span><br><span class="line">lock = RLock()</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="comment">#1. dosomething1</span></span><br><span class="line">    <span class="comment">#2. io操作</span></span><br><span class="line">    <span class="comment"># 1. dosomething3</span></span><br><span class="line">    <span class="keyword">global</span> lock</span><br><span class="line">    <span class="keyword">global</span> total</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">1000000</span>):</span><br><span class="line">        lock.acquire()</span><br><span class="line">        lock.acquire()</span><br><span class="line">        total += <span class="number">1</span></span><br><span class="line">        lock.release()</span><br><span class="line">        lock.release()</span><br></pre></td></tr></table></figure>

<h4 id="condition"><a href="#condition" class="headerlink" title="condition"></a>condition</h4><p>是条件变量， 用于复杂的线程间同步</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#通过condition完成协同读诗</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">XiaoAi</span><span class="params">(threading.Thread)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, cond)</span>:</span></span><br><span class="line">        super().__init__(name=<span class="string">"小爱"</span>)</span><br><span class="line">        self.cond = cond</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">run</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">with</span> self.cond:</span><br><span class="line">            self.cond.wait()</span><br><span class="line">            print(<span class="string">"&#123;&#125; : 在 "</span>.format(self.name))</span><br><span class="line">            self.cond.notify()</span><br><span class="line"></span><br><span class="line">            self.cond.wait()</span><br><span class="line">            print(<span class="string">"&#123;&#125; : 好啊 "</span>.format(self.name))</span><br><span class="line">            self.cond.notify()</span><br><span class="line"></span><br><span class="line">            self.cond.wait()</span><br><span class="line">            print(<span class="string">"&#123;&#125; : 君住长江尾 "</span>.format(self.name))</span><br><span class="line">            self.cond.notify()</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">TianMao</span><span class="params">(threading.Thread)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, cond)</span>:</span></span><br><span class="line">        super().__init__(name=<span class="string">"天猫精灵"</span>)</span><br><span class="line">        self.cond = cond</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">run</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">with</span> self.cond:</span><br><span class="line">            print(<span class="string">"&#123;&#125; : 小爱同学 "</span>.format(self.name))</span><br><span class="line">            self.cond.notify()</span><br><span class="line">            self.cond.wait()</span><br><span class="line"></span><br><span class="line">            print(<span class="string">"&#123;&#125; : 我们来对古诗吧 "</span>.format(self.name))</span><br><span class="line">            self.cond.notify()</span><br><span class="line">            self.cond.wait()</span><br><span class="line"></span><br><span class="line">            print(<span class="string">"&#123;&#125; : 我住长江头 "</span>.format(self.name))</span><br><span class="line">            self.cond.notify()</span><br><span class="line">            self.cond.wait()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">"__main__"</span>:</span><br><span class="line">    <span class="keyword">from</span> concurrent <span class="keyword">import</span> futures</span><br><span class="line">    cond = threading.Condition()</span><br><span class="line">    xiaoai = XiaoAi(cond)</span><br><span class="line">    tianmao = TianMao(cond)</span><br><span class="line"></span><br><span class="line">    <span class="comment">#启动顺序很重要</span></span><br><span class="line">    <span class="comment">#在调用with cond之后才能调用wait或者notify方法</span></span><br><span class="line">    <span class="comment">#condition有两层锁， 一把底层锁会在线程调用了wait方法的时候释放， 上面的锁会在每次调用wait的时候分配一把并放入到cond的等待队列中，等到notify方法的唤醒</span></span><br><span class="line">    xiaoai.start()</span><br><span class="line">    tianmao.start()</span><br></pre></td></tr></table></figure>



<h4 id="semaphore"><a href="#semaphore" class="headerlink" title="semaphore"></a>semaphore</h4><p>semaphore是利用condition实现用于控制进入数量的锁</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#Semaphore 是用于控制进入数量的锁</span></span><br><span class="line"><span class="comment">#文件， 读、写， 写一般只是用于一个线程写，读可以允许有多个</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#做爬虫</span></span><br><span class="line"><span class="keyword">import</span> threading</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">HtmlSpider</span><span class="params">(threading.Thread)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, url, sem)</span>:</span></span><br><span class="line">        super().__init__()</span><br><span class="line">        self.url = url</span><br><span class="line">        self.sem = sem</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">run</span><span class="params">(self)</span>:</span></span><br><span class="line">        time.sleep(<span class="number">2</span>)</span><br><span class="line">        print(<span class="string">"got html text success"</span>)</span><br><span class="line">        self.sem.release()  <span class="comment"># 任务结束，释放锁</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">UrlProducer</span><span class="params">(threading.Thread)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, sem)</span>:</span></span><br><span class="line">        super().__init__()</span><br><span class="line">        self.sem = sem</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">run</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">20</span>):</span><br><span class="line">            self.sem.acquire()  <span class="comment"># 上锁，当数量大于3的时候阻塞</span></span><br><span class="line">            html_thread = HtmlSpider(<span class="string">"https://baidu.com/&#123;&#125;"</span>.format(i), self.sem)</span><br><span class="line">            html_thread.start()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">"__main__"</span>:</span><br><span class="line">    sem = threading.Semaphore(<span class="number">3</span>)  <span class="comment"># 实例化Semaphore，限制同时最大数量为3</span></span><br><span class="line">    url_producer = UrlProducer(sem)</span><br><span class="line">    url_producer.start()</span><br></pre></td></tr></table></figure>



<h4 id="ThreadPoolExecutor线程池"><a href="#ThreadPoolExecutor线程池" class="headerlink" title="ThreadPoolExecutor线程池"></a>ThreadPoolExecutor线程池</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> concurrent.futures <span class="keyword">import</span> ThreadPoolExecutor, as_completed, wait, FIRST_COMPLETED</span><br><span class="line"><span class="keyword">from</span> concurrent.futures <span class="keyword">import</span> Future</span><br><span class="line"></span><br><span class="line"><span class="comment"># future未来对象，或者叫task的返回容器</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#线程池， 为什么要线程池</span></span><br><span class="line"><span class="comment">#主线程中可以获取某一个线程的状态或者某一个任务的状态，以及返回值</span></span><br><span class="line"><span class="comment">#当一个线程完成的时候我们主线程能立即知道</span></span><br><span class="line"><span class="comment">#futures可以让多线程和多进程编码接口一致</span></span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_html</span><span class="params">(times)</span>:</span></span><br><span class="line">    time.sleep(times)</span><br><span class="line">    print(<span class="string">"get page &#123;&#125; success"</span>.format(times))</span><br><span class="line">    <span class="keyword">return</span> times</span><br><span class="line"></span><br><span class="line">executor = ThreadPoolExecutor(max_workers=<span class="number">2</span>)</span><br><span class="line"><span class="comment">#通过submit函数提交执行的函数到线程池中, submit 是立即返回</span></span><br><span class="line">task1 = executor.submit(get_html, (<span class="number">3</span>))</span><br><span class="line">task2 = executor.submit(get_html, (<span class="number">2</span>))</span><br><span class="line"><span class="comment"># task1和task2就是future对象</span></span><br><span class="line"><span class="comment"># done方法用于判定某个任务是否完成</span></span><br><span class="line">print(task1.done())</span><br><span class="line">print(task2.cancel())  <span class="comment"># 取消某个还没运行的任务</span></span><br><span class="line">time.sleep(<span class="number">3</span>)</span><br><span class="line">print(task1.done())</span><br><span class="line"><span class="comment"># result方法可以获取task的执行结果</span></span><br><span class="line">print(task1.result())</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 要获取已经成功的task的返回</span></span><br><span class="line"><span class="comment"># 方法一，返回是按照任务成功的先后</span></span><br><span class="line">urls = [<span class="number">3</span>,<span class="number">2</span>,<span class="number">4</span>]</span><br><span class="line">all_task = [executor.submit(get_html, (url)) <span class="keyword">for</span> url <span class="keyword">in</span> urls]</span><br><span class="line"><span class="keyword">for</span> future <span class="keyword">in</span> as_completed(all_task):</span><br><span class="line">    data = future.result()</span><br><span class="line">    print(<span class="string">"get &#123;&#125; page"</span>.format(data))</span><br><span class="line"></span><br><span class="line"><span class="comment"># 方法二， 返回是按照urls里的顺序</span></span><br><span class="line"><span class="comment">#通过executor的map获取已经完成的task的值</span></span><br><span class="line"><span class="keyword">for</span> data <span class="keyword">in</span> executor.map(get_html, urls):</span><br><span class="line">    print(<span class="string">"get &#123;&#125; page"</span>.format(data))</span><br><span class="line">    </span><br><span class="line"><span class="comment"># wait函数是等待一定条件（默认是所有任务执行完）满足后再继续执行主线程</span></span><br><span class="line"><span class="comment"># return_when=FIRST_COMPLETED 参数是完成第一个任务后就继续执行主线程</span></span><br><span class="line">wait(all_task, return_when=FIRST_COMPLETED)</span><br><span class="line">print(<span class="string">"main"</span>)</span><br></pre></td></tr></table></figure>



<h4 id="multiprocessing-多进程编程"><a href="#multiprocessing-多进程编程" class="headerlink" title="multiprocessing 多进程编程"></a>multiprocessing 多进程编程</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> multiprocessing</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_html</span><span class="params">(n)</span>:</span></span><br><span class="line">    time.sleep(n)</span><br><span class="line">    print(<span class="string">"sub_progress success"</span>)</span><br><span class="line">    <span class="keyword">return</span> n</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">"__main__"</span>:</span><br><span class="line">    progress = multiprocessing.Process(target=get_html, args=(<span class="number">2</span>,))</span><br><span class="line">    print(progress.pid)</span><br><span class="line">    progress.start()</span><br><span class="line">    print(progress.pid)</span><br><span class="line">    progress.join()</span><br><span class="line">    print(<span class="string">"main progress end"</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 使用线程池</span></span><br><span class="line">    pool = multiprocessing.Pool(multiprocessing.cpu_count())  <span class="comment"># 进程开启数量为cpu核心数</span></span><br><span class="line">    result = pool.apply_async(get_html, args=(<span class="number">3</span>,))</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 等待所有任务完成</span></span><br><span class="line">    pool.close()</span><br><span class="line">    pool.join()  <span class="comment"># join()前必须先close()否则会报错</span></span><br><span class="line">    </span><br><span class="line">    print(result.get())</span><br><span class="line"></span><br><span class="line">    <span class="comment"># imap 运行结果顺序为添加参数的顺序，即1,5,3</span></span><br><span class="line">    <span class="keyword">for</span> result <span class="keyword">in</span> pool.imap(get_html, [<span class="number">1</span>,<span class="number">5</span>,<span class="number">3</span>]):</span><br><span class="line">        print(<span class="string">"&#123;&#125; sleep success"</span>.format(result))</span><br><span class="line"></span><br><span class="line">    <span class="comment"># imap_unordered 运行结果的顺序为执行时间的顺序，即1，3，5</span></span><br><span class="line">    <span class="keyword">for</span> result <span class="keyword">in</span> pool.imap_unordered(get_html, [<span class="number">1</span>,<span class="number">5</span>,<span class="number">3</span>]):</span><br><span class="line">        print(<span class="string">"&#123;&#125; sleep success"</span>.format(result))</span><br></pre></td></tr></table></figure>



<h4 id="进程间通信-Queue、Pipe，Manager"><a href="#进程间通信-Queue、Pipe，Manager" class="headerlink" title="进程间通信 - Queue、Pipe，Manager"></a>进程间通信 - Queue、Pipe，Manager</h4><p>multiprocessing.Queue</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">from</span> multiprocessing <span class="keyword">import</span> Process, Queue, Pool</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">producer</span><span class="params">(queue)</span>:</span></span><br><span class="line">    queue.put(<span class="string">"a"</span>)</span><br><span class="line">    time.sleep(<span class="number">2</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">consumer</span><span class="params">(queue)</span>:</span></span><br><span class="line">    time.sleep(<span class="number">2</span>)</span><br><span class="line">    data = queue.get()</span><br><span class="line">    print(data)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">"__main__"</span>:</span><br><span class="line">    queue = Queue(<span class="number">10</span>)</span><br><span class="line">    my_producer = Process(target=producer, args=(queue,))</span><br><span class="line">    my_consumer = Process(target=consumer, args=(queue,))</span><br><span class="line">    my_producer.start()</span><br><span class="line">    my_consumer.start()</span><br><span class="line">    my_producer.join()</span><br><span class="line">    my_consumer.join()</span><br></pre></td></tr></table></figure>

<p>Manager().Queue</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> multiprocessing <span class="keyword">import</span> Process, Manage, Pool</span><br><span class="line"><span class="comment"># multiprocessing中的queue不能用于pool进程池</span></span><br><span class="line"><span class="comment"># pool中的进程间通信需要使用manager中的queue</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">producer</span><span class="params">(queue)</span>:</span></span><br><span class="line">    queue.put(<span class="string">"a"</span>)</span><br><span class="line">    time.sleep(<span class="number">2</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">consumer</span><span class="params">(queue)</span>:</span></span><br><span class="line">    time.sleep(<span class="number">2</span>)</span><br><span class="line">    data = queue.get()</span><br><span class="line">    print(data)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">"__main__"</span>:</span><br><span class="line">    queue = Manager().Queue(<span class="number">10</span>)</span><br><span class="line">    pool = Pool(<span class="number">2</span>)</span><br><span class="line"></span><br><span class="line">    pool.apply_async(producer, args=(queue,))</span><br><span class="line">    pool.apply_async(consumer, args=(queue,))</span><br><span class="line"></span><br><span class="line">    pool.close()</span><br><span class="line">    pool.join()</span><br></pre></td></tr></table></figure>



<p>multiprocessing.Pipe</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> multiprocessing <span class="keyword">import</span> Process, Pool, Pipe</span><br><span class="line"><span class="comment">#通过pipe实现进程间通信</span></span><br><span class="line"><span class="comment">#pipe的性能高于queue</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">producer</span><span class="params">(pipe)</span>:</span></span><br><span class="line">    pipe.send(<span class="string">"bobby"</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">consumer</span><span class="params">(pipe)</span>:</span></span><br><span class="line">    print(pipe.recv())</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">"__main__"</span>:</span><br><span class="line">    recevie_pipe, send_pipe = Pipe()</span><br><span class="line">    <span class="comment">#pipe只能适用于两个进程</span></span><br><span class="line">    my_producer= Process(target=producer, args=(send_pipe, ))</span><br><span class="line">    my_consumer = Process(target=consumer, args=(recevie_pipe,))</span><br><span class="line"></span><br><span class="line">    my_producer.start()</span><br><span class="line">    my_consumer.start()</span><br><span class="line">    my_producer.join()</span><br><span class="line">    my_consumer.join()</span><br></pre></td></tr></table></figure>



<p>Manager().dict()</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> multiprocessing <span class="keyword">import</span> Process, Manage</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add_data</span><span class="params">(p_dict, key, value)</span>:</span></span><br><span class="line">    p_dict[key] = value</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">"__main__"</span>:</span><br><span class="line">    progress_dict = Manager().dict()</span><br><span class="line">    <span class="keyword">from</span> queue <span class="keyword">import</span> PriorityQueue</span><br><span class="line"></span><br><span class="line">    first_progress = Process(target=add_data, args=(progress_dict, <span class="string">"bobby1"</span>, <span class="number">22</span>))</span><br><span class="line">    second_progress = Process(target=add_data, args=(progress_dict, <span class="string">"bobby2"</span>, <span class="number">23</span>))</span><br><span class="line"></span><br><span class="line">    first_progress.start()</span><br><span class="line">    second_progress.start()</span><br><span class="line">    first_progress.join()</span><br><span class="line">    second_progress.join()</span><br><span class="line"></span><br><span class="line">    print(progress_dict)</span><br></pre></td></tr></table></figure>



<h1 id="第十二章-协程和异步IO"><a href="#第十二章-协程和异步IO" class="headerlink" title="第十二章 协程和异步IO"></a>第十二章 协程和异步IO</h1><h4 id="并发、并行、同步、异步、阻塞、非阻塞"><a href="#并发、并行、同步、异步、阻塞、非阻塞" class="headerlink" title="并发、并行、同步、异步、阻塞、非阻塞"></a>并发、并行、同步、异步、阻塞、非阻塞</h4><p>并发：是指一个时间段内，有几个程序在同一个CPU上运行，但是任意时刻只有一个程序在CPU上运行。</p>
<p>并行：是指任意时刻点上，有多个程序同时运行在多个CPU上。</p>
<p>同步：是指代码调用IO操作时，必须等待IO操作完成才返回的调用方式。</p>
<p>异步：是指代码调用IO操作时，不必等IO操作完成就返回的调用方式。</p>
<p>阻塞：是指调用函数时候当前线程被挂起。</p>
<p>非阻塞：是指调用函数时候当前线程不会被挂起，而是立即返回。</p>
<h4 id="I-O多路复用"><a href="#I-O多路复用" class="headerlink" title="I/O多路复用"></a>I/O多路复用</h4><p>Unix下五种I/O模型：</p>
<p>阻塞式I/O、非阻塞式I/O、I/O复用、信号驱动式I/O，异步I/O(POSIX的aio_系列函数)</p>
<p><img src="/2020/05/16/python/Python%E9%AB%98%E7%BA%A7%E7%BC%96%E7%A8%8B%E5%92%8C%E5%BC%82%E6%AD%A5IO%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B/WX20190616-162543@2x.png" alt></p>
<p><img src="/2020/05/16/python/Python%E9%AB%98%E7%BA%A7%E7%BC%96%E7%A8%8B%E5%92%8C%E5%BC%82%E6%AD%A5IO%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B/WX20190616-162613@2x.png" alt></p>
<p>阻塞式I/O优于非阻塞式I/O的情况：</p>
<p>非阻塞式I/O不一定就好于阻塞式I/O，例如client.connect((host, 80))是阻塞式I/O，在此之后如果是执行client.send()，因为连接成功后才可以send，所以如果用client.setblocking(False)把它设置成非阻塞式I/O，那么在send之前就要不停的询问连接是否建立好， 需要while循环不停的去检查状态，否则如果没建立好连接就send，就可能会报错，阻塞式I/O不消耗CPU，而此时用while循环反而消耗CPU。</p>
<p>非阻塞式I/O优于阻塞式I/O的情况：</p>
<p>如果client.connect((host, 80))之后不是执行client.send()操作，而是做计算任务或者再次发起其他的连接请求，那么设置成非阻塞I/O，立刻执行下面的操作就不会报错，从而是提升了效率。</p>
<p><img src="/2020/05/16/python/Python%E9%AB%98%E7%BA%A7%E7%BC%96%E7%A8%8B%E5%92%8C%E5%BC%82%E6%AD%A5IO%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B/WX20190616-163944@2x.png" alt></p>
<p>select是操作系统提供的函数，加入现在有100scoket连接，调用select函数，可以得到哪些socket连接完成，然后接收数据。</p>
<p><img src="/2020/05/16/python/Python%E9%AB%98%E7%BA%A7%E7%BC%96%E7%A8%8B%E5%92%8C%E5%BC%82%E6%AD%A5IO%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B/WX20190616-164335@2x.png" alt></p>
<p><img src="/2020/05/16/python/Python%E9%AB%98%E7%BA%A7%E7%BC%96%E7%A8%8B%E5%92%8C%E5%BC%82%E6%AD%A5IO%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B/WX20190616-164419@2x.png" alt></p>
<p><img src="/2020/05/16/python/Python%E9%AB%98%E7%BA%A7%E7%BC%96%E7%A8%8B%E5%92%8C%E5%BC%82%E6%AD%A5IO%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B/WX20190616-164924@2x.png" alt></p>
<p><img src="/2020/05/16/python/Python%E9%AB%98%E7%BA%A7%E7%BC%96%E7%A8%8B%E5%92%8C%E5%BC%82%E6%AD%A5IO%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B/WX20190616-165100@2x.png" alt></p>
<p><img src="/2020/05/16/python/Python%E9%AB%98%E7%BA%A7%E7%BC%96%E7%A8%8B%E5%92%8C%E5%BC%82%E6%AD%A5IO%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B/WX20190616-165223@2x.png" alt></p>
<p><img src="/2020/05/16/python/Python%E9%AB%98%E7%BA%A7%E7%BC%96%E7%A8%8B%E5%92%8C%E5%BC%82%E6%AD%A5IO%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B/WX20190616-165312@2x.png" alt></p>
<ul>
<li>epoll并不代表一定比select好</li>
<li>在并发高的情况下，连接活跃度不是很高， epoll比select</li>
<li>并发性不高，同时连接很活跃， select比epoll好</li>
</ul>
<h4 id="select-回调-事件循环获取html"><a href="#select-回调-事件循环获取html" class="headerlink" title="select+回调+事件循环获取html"></a>select+回调+事件循环获取html</h4><p>过程：</p>
<p>1、把socket文件描述符、事件、回调函数注册进selector</p>
<p>2、使用loop()事件循环不停的请求socket的状态并调用对应的回调函数(select本身并不会在socket状态变化后调用回调函数，而是需要程序员写一个loop()事件循环的函数，不停请求socket状态，请求到某个socket状态完成，调用对应的回调函数)</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#通过非阻塞io实现http请求</span></span><br><span class="line"><span class="comment"># select + 回调 + 事件循环</span></span><br><span class="line"><span class="comment">#  并发性高</span></span><br><span class="line"><span class="comment"># 使用单线程</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> socket</span><br><span class="line"><span class="keyword">from</span> urllib.parse <span class="keyword">import</span> urlparse</span><br><span class="line"><span class="keyword">from</span> selectors <span class="keyword">import</span> DefaultSelector, EVENT_READ, EVENT_WRITE</span><br><span class="line"></span><br><span class="line">selector = DefaultSelector()</span><br><span class="line"><span class="comment">#使用select完成http请求</span></span><br><span class="line">urls = []</span><br><span class="line">stop = <span class="literal">False</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Fetcher</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">connected</span><span class="params">(self, key)</span>:</span></span><br><span class="line">        selector.unregister(key.fd)  <span class="comment"># 连接建立好之后要取消注册</span></span><br><span class="line">        self.client.send(<span class="string">"GET &#123;&#125; HTTP/1.1\r\nHost:&#123;&#125;\r\nConnection:close\r\n\r\n"</span>.format(self.path, self.host).encode(<span class="string">"utf8"</span>))</span><br><span class="line">        <span class="comment"># 此处是监听是否可读</span></span><br><span class="line">        selector.register(self.client.fileno(), EVENT_READ, self.readable)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">readable</span><span class="params">(self, key)</span>:</span></span><br><span class="line">        d = self.client.recv(<span class="number">1024</span>)</span><br><span class="line">        <span class="keyword">if</span> d:</span><br><span class="line">            self.data += d</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            selector.unregister(key.fd)</span><br><span class="line">            data = self.data.decode(<span class="string">"utf8"</span>)</span><br><span class="line">            html_data = data.split(<span class="string">"\r\n\r\n"</span>)[<span class="number">1</span>]</span><br><span class="line">            print(html_data)</span><br><span class="line">            self.client.close()</span><br><span class="line">            urls.remove(self.spider_url)</span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">not</span> urls:</span><br><span class="line">                <span class="keyword">global</span> stop</span><br><span class="line">                stop = <span class="literal">True</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get_url</span><span class="params">(self, url)</span>:</span></span><br><span class="line">        self.spider_url = url</span><br><span class="line">        url = urlparse(url)</span><br><span class="line">        self.host = url.netloc</span><br><span class="line">        self.path = url.path</span><br><span class="line">        self.data = <span class="string">b""</span></span><br><span class="line">        <span class="keyword">if</span> self.path == <span class="string">""</span>:</span><br><span class="line">            self.path = <span class="string">"/"</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># 建立socket连接</span></span><br><span class="line">        self.client = socket.socket(socket.AF_INET, socket.SOCK_STREAM)</span><br><span class="line">        self.client.setblocking(<span class="literal">False</span>)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            self.client.connect((self.host, <span class="number">80</span>))  <span class="comment"># 阻塞不会消耗cpu</span></span><br><span class="line">        <span class="keyword">except</span> BlockingIOError <span class="keyword">as</span> e:</span><br><span class="line">            <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># 注册，self.client.fileno()是socket的文件描述符，注册的是文件描述符</span></span><br><span class="line">        <span class="comment"># 此处是监听是否可写</span></span><br><span class="line">        selector.register(self.client.fileno(), EVENT_WRITE, self.connected)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">loop</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="comment">#事件循环，不停的请求socket的状态并调用对应的回调函数</span></span><br><span class="line">    <span class="comment">#1. select本身是不支持register模式</span></span><br><span class="line">    <span class="comment">#2. socket状态变化以后的回调是由程序员完成的</span></span><br><span class="line">    <span class="keyword">while</span> <span class="keyword">not</span> stop:</span><br><span class="line">        ready = selector.select()</span><br><span class="line">        <span class="keyword">for</span> key, mask <span class="keyword">in</span> ready:</span><br><span class="line">            call_back = key.data</span><br><span class="line">            call_back(key)</span><br><span class="line">    <span class="comment">#回调+事件循环+select(poll\epoll)</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">"__main__"</span>:</span><br><span class="line">    fetcher = Fetcher()</span><br><span class="line">    <span class="keyword">import</span> time</span><br><span class="line">    start_time = time.time()</span><br><span class="line">    <span class="keyword">for</span> url <span class="keyword">in</span> range(<span class="number">20</span>):</span><br><span class="line">        url = <span class="string">"http://shop.projectsedu.com/goods/&#123;&#125;/"</span>.format(url)</span><br><span class="line">        urls.append(url)</span><br><span class="line">        fetcher = Fetcher()</span><br><span class="line">        fetcher.get_url(url)</span><br><span class="line">    loop()</span><br><span class="line">    print(time.time()-start_time)</span><br></pre></td></tr></table></figure>

<p><img src="/2020/05/16/python/Python%E9%AB%98%E7%BA%A7%E7%BC%96%E7%A8%8B%E5%92%8C%E5%BC%82%E6%AD%A5IO%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B/WX20190616-175035@2x.png" alt></p>
<ol>
<li>可读性差</li>
<li>共享状态管理困难</li>
<li>异常处理困难</li>
</ol>
<h4 id="生成器-1"><a href="#生成器-1" class="headerlink" title="生成器"></a>生成器</h4><ul>
<li>传统函数调用 过程 A-&gt;B-&gt;C</li>
<li>我们需要一个可以暂停的函数，并且可以在适当的时候恢复该函数的继续执行</li>
<li>出现了协程 -&gt; 说法1：有多个入口的函数，说法2： 可以暂停的函数， 可以暂停的函数(可以向暂停的地方传入值)</li>
</ul>
<p>生成器的方法：</p>
<ul>
<li>next(gen)</li>
<li>gen.send()</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">gen_func</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="comment"># 1. 可以产出值， 2. 可以接收值(调用方传递进来的值)</span></span><br><span class="line">    html = <span class="keyword">yield</span> <span class="string">"http://projectsedu.com"</span></span><br><span class="line">    print(html)</span><br><span class="line">    <span class="keyword">return</span> <span class="string">"bobby"</span></span><br><span class="line">  </span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">"__main__"</span>:</span><br><span class="line">    gen = gen_func()</span><br><span class="line">    <span class="comment"># 在调用send发送非none值之前，我们必须启动一次生成器， 方式有两种1. gen.send(None), 2. next(gen)</span></span><br><span class="line">    url = gen.send(<span class="literal">None</span>)</span><br><span class="line">    <span class="comment"># download url</span></span><br><span class="line">    html = <span class="string">"bobby"</span></span><br><span class="line">    print(gen.send(html)) <span class="comment">#send方法可以传递值进入生成器内部，同时还可以重启生成器执行到下一个yield位置</span></span><br><span class="line">    print(gen.send(html))</span><br></pre></td></tr></table></figure>

<ul>
<li>gen.close()  关闭生成器(如果在yield处捕获异常，就会在close()处抛出异常)</li>
<li>gen.throw()  向生成器内传入异常</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">gen_func</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="keyword">yield</span> <span class="string">"http://projectsedu.com"</span></span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">        <span class="keyword">pass</span></span><br><span class="line">    <span class="keyword">yield</span> <span class="number">2</span></span><br><span class="line">    <span class="keyword">yield</span> <span class="number">3</span></span><br><span class="line">    <span class="keyword">return</span> <span class="string">"bobby"</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">"__main__"</span>:</span><br><span class="line">    gen = gen_func()</span><br><span class="line">    print(next(gen))</span><br><span class="line">    gen.throw(Exception, <span class="string">"download error"</span>)</span><br></pre></td></tr></table></figure>



<h4 id="yield-from"><a href="#yield-from" class="headerlink" title="yield from"></a>yield from</h4><p>yield from的一个例子</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">final_result = &#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">sales_sum</span><span class="params">(pro_name)</span>:</span></span><br><span class="line">    total = <span class="number">0</span></span><br><span class="line">    nums = []</span><br><span class="line">    <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">        x = <span class="keyword">yield</span></span><br><span class="line">        print(pro_name+<span class="string">"销量: "</span>, x)</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> x:</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">        total += x</span><br><span class="line">        nums.append(x)</span><br><span class="line">    <span class="keyword">return</span> total, nums</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">middle</span><span class="params">(key)</span>:</span></span><br><span class="line">    <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">        final_result[key] = <span class="keyword">yield</span> <span class="keyword">from</span> sales_sum(key)</span><br><span class="line">        print(key+<span class="string">"销量统计完成！！."</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">main</span><span class="params">()</span>:</span></span><br><span class="line">    data_sets = &#123;</span><br><span class="line">        <span class="string">"bobby牌面膜"</span>: [<span class="number">1200</span>, <span class="number">1500</span>, <span class="number">3000</span>],</span><br><span class="line">        <span class="string">"bobby牌手机"</span>: [<span class="number">28</span>,<span class="number">55</span>,<span class="number">98</span>,<span class="number">108</span> ],</span><br><span class="line">        <span class="string">"bobby牌大衣"</span>: [<span class="number">280</span>,<span class="number">560</span>,<span class="number">778</span>,<span class="number">70</span>],</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">for</span> key, data_set <span class="keyword">in</span> data_sets.items():</span><br><span class="line">        print(<span class="string">"start key:"</span>, key)</span><br><span class="line">        m = middle(key)</span><br><span class="line">        m.send(<span class="literal">None</span>) <span class="comment"># 预激middle协程</span></span><br><span class="line">        <span class="keyword">for</span> value <span class="keyword">in</span> data_set:</span><br><span class="line">            m.send(value)   <span class="comment"># 给协程传递每一组的值</span></span><br><span class="line">        m.send(<span class="literal">None</span>)</span><br><span class="line">    print(<span class="string">"final_result:"</span>, final_result)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    main()</span><br></pre></td></tr></table></figure>

<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># yield from的源码和解释</span></span><br><span class="line"><span class="comment">#pep380</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#1. RESULT = yield from EXPR可以简化成下面这样</span></span><br><span class="line"><span class="comment">#一些说明</span></span><br><span class="line"><span class="string">"""</span></span><br><span class="line"><span class="string">_i：子生成器，同时也是一个迭代器</span></span><br><span class="line"><span class="string">_y：子生成器生产的值</span></span><br><span class="line"><span class="string">_r：yield from 表达式最终的值</span></span><br><span class="line"><span class="string">_s：调用方通过send()发送的值</span></span><br><span class="line"><span class="string">_e：异常对象</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">"""</span></span><br><span class="line"></span><br><span class="line">_i = iter(EXPR)      <span class="comment"># EXPR是一个可迭代对象，_i其实是子生成器；</span></span><br><span class="line"><span class="keyword">try</span>:</span><br><span class="line">    _y = next(_i)   <span class="comment"># 预激子生成器，把产出的第一个值存在_y中；</span></span><br><span class="line"><span class="keyword">except</span> StopIteration <span class="keyword">as</span> _e:</span><br><span class="line">    _r = _e.value   <span class="comment"># 如果抛出了`StopIteration`异常，那么就将异常对象的`value`属性保存到_r，这是最简单的情况的返回值；</span></span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    <span class="keyword">while</span> <span class="number">1</span>:    <span class="comment"># 尝试执行这个循环，委托生成器会阻塞；</span></span><br><span class="line">        _s = <span class="keyword">yield</span> _y   <span class="comment"># 生产子生成器的值，等待调用方`send()`值，发送过来的值将保存在_s中；</span></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            _y = _i.send(_s)    <span class="comment"># 转发_s，并且尝试向下执行；</span></span><br><span class="line">        <span class="keyword">except</span> StopIteration <span class="keyword">as</span> _e:</span><br><span class="line">            _r = _e.value       <span class="comment"># 如果子生成器抛出异常，那么就获取异常对象的`value`属性存到_r，退出循环，恢复委托生成器的运行；</span></span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">RESULT = _r     <span class="comment"># _r就是整个yield from表达式返回的值。</span></span><br><span class="line"></span><br><span class="line"><span class="string">"""</span></span><br><span class="line"><span class="string">1. 子生成器可能只是一个迭代器，并不是一个作为协程的生成器，所以它不支持.throw()和.close()方法；</span></span><br><span class="line"><span class="string">2. 如果子生成器支持.throw()和.close()方法，但是在子生成器内部，这两个方法都会抛出异常；</span></span><br><span class="line"><span class="string">3. 调用方让子生成器自己抛出异常</span></span><br><span class="line"><span class="string">4. 当调用方使用next()或者.send(None)时，都要在子生成器上调用next()函数，当调用方使用.send()发送非 None 值时，才调用子生成器的.send()方法；</span></span><br><span class="line"><span class="string">"""</span></span><br><span class="line">_i = iter(EXPR)</span><br><span class="line"><span class="keyword">try</span>:</span><br><span class="line">    _y = next(_i)</span><br><span class="line"><span class="keyword">except</span> StopIteration <span class="keyword">as</span> _e:</span><br><span class="line">    _r = _e.value</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    <span class="keyword">while</span> <span class="number">1</span>:</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            _s = <span class="keyword">yield</span> _y</span><br><span class="line">        <span class="keyword">except</span> GeneratorExit <span class="keyword">as</span> _e:</span><br><span class="line">            <span class="keyword">try</span>:</span><br><span class="line">                _m = _i.close</span><br><span class="line">            <span class="keyword">except</span> AttributeError:</span><br><span class="line">                <span class="keyword">pass</span></span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                _m()</span><br><span class="line">            <span class="keyword">raise</span> _e</span><br><span class="line">        <span class="keyword">except</span> BaseException <span class="keyword">as</span> _e:</span><br><span class="line">            _x = sys.exc_info()</span><br><span class="line">            <span class="keyword">try</span>:</span><br><span class="line">                _m = _i.throw</span><br><span class="line">            <span class="keyword">except</span> AttributeError:</span><br><span class="line">                <span class="keyword">raise</span> _e</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                <span class="keyword">try</span>:</span><br><span class="line">                    _y = _m(*_x)</span><br><span class="line">                <span class="keyword">except</span> StopIteration <span class="keyword">as</span> _e:</span><br><span class="line">                    _r = _e.value</span><br><span class="line">                    <span class="keyword">break</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">try</span>:</span><br><span class="line">                <span class="keyword">if</span> _s <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">                    _y = next(_i)</span><br><span class="line">                <span class="keyword">else</span>:</span><br><span class="line">                    _y = _i.send(_s)</span><br><span class="line">            <span class="keyword">except</span> StopIteration <span class="keyword">as</span> _e:</span><br><span class="line">                _r = _e.value</span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line">RESULT = _r</span><br><span class="line"></span><br><span class="line"><span class="string">"""</span></span><br><span class="line"><span class="string">看完代码，我们总结一下关键点：</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">1. 子生成器生产的值，都是直接传给调用方的；调用方通过.send()发送的值都是直接传递给子生成器的；如果发送的是 None，会调用子生成器的__next__()方法，如果不是 None，会调用子生成器的.send()方法；</span></span><br><span class="line"><span class="string">2. 子生成器退出的时候，最后的return EXPR，会触发一个StopIteration(EXPR)异常；</span></span><br><span class="line"><span class="string">3. yield from表达式的值，是子生成器终止时，传递给StopIteration异常的第一个参数；</span></span><br><span class="line"><span class="string">4. 如果调用的时候出现StopIteration异常，委托生成器会恢复运行，同时其他的异常会向上 "冒泡"；</span></span><br><span class="line"><span class="string">5. 传入委托生成器的异常里，除了GeneratorExit之外，其他的所有异常全部传递给子生成器的.throw()方法；如果调用.throw()的时候出现了StopIteration异常，那么就恢复委托生成器的运行，其他的异常全部向上 "冒泡"；</span></span><br><span class="line"><span class="string">6. 如果在委托生成器上调用.close()或传入GeneratorExit异常，会调用子生成器的.close()方法，没有的话就不调用。如果在调用.close()的时候抛出了异常，那么就向上 "冒泡"，否则的话委托生成器会抛出GeneratorExit异常。</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">"""</span></span><br></pre></td></tr></table></figure>



<p>chain函数</p>
<p>它接受一个可迭代对象列表作为输入，并返回一个迭代器，有效的屏蔽掉在多个容器中迭代细节。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> itertools <span class="keyword">import</span> chain</span><br><span class="line">a = [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>]</span><br><span class="line">b = [<span class="string">'x'</span>, <span class="string">'y'</span>, <span class="string">'z'</span>]</span><br><span class="line"><span class="keyword">for</span> x <span class="keyword">in</span> chain(a, b):</span><br><span class="line">	print(x)</span><br><span class="line">  </span><br><span class="line">&gt;&gt;&gt;</span><br><span class="line"><span class="number">1</span></span><br><span class="line"><span class="number">2</span></span><br><span class="line"><span class="number">3</span></span><br><span class="line"><span class="number">4</span></span><br><span class="line">x</span><br><span class="line">y</span><br><span class="line">z</span><br><span class="line">&gt;&gt;&gt;</span><br></pre></td></tr></table></figure>



<p>偏函数partial</p>
<p>partial函数的作用就是：将所作用的函数作为partial()函数的第一个参数，原函数的各个参数依次作为partial()函数的后续参数，原函数有关键字参数的一定要带上关键字，没有的话，按原有参数顺序进行补充。</p>
<p>偏函数的第二个部分(可变参数)，按原有函数的参数顺序进行补充，参数将作用在原函数上，最后偏函数返回一个新函数（类似于，装饰器decorator，对于函数进行二次包装，产生特殊效果；但又不同于装饰器，偏函数产生了一个新函数，而装饰器，可改变被装饰函数的函数入口地址也可以不影响原函数）</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add</span><span class="params">(a,b,c=<span class="number">2</span>)</span>:</span></span><br><span class="line">    print(<span class="string">"a is:%s b is %s c is %s"</span>%(a,b,c))</span><br><span class="line">    <span class="keyword">return</span> a+b+c</span><br><span class="line">add_with_a_b=partial(add,<span class="number">2</span>,<span class="number">3</span>)</span><br><span class="line">print(add_with_a_b())<span class="comment"># it's 7</span></span><br><span class="line">add_with_a=partial(add,<span class="number">9</span>)</span><br><span class="line">print(add_with_a(<span class="number">10</span>))<span class="comment"># it's 21</span></span><br><span class="line"><span class="comment">#################</span></span><br><span class="line">a <span class="keyword">is</span>:<span class="number">2</span> b <span class="keyword">is</span> <span class="number">3</span> c <span class="keyword">is</span> <span class="number">2</span></span><br><span class="line"><span class="number">7</span></span><br><span class="line">a <span class="keyword">is</span>:<span class="number">9</span> b <span class="keyword">is</span> <span class="number">10</span> c <span class="keyword">is</span> <span class="number">2</span></span><br><span class="line"><span class="number">21</span></span><br></pre></td></tr></table></figure>



<h1 id="第十三章-asyncio并发编程"><a href="#第十三章-asyncio并发编程" class="headerlink" title="第十三章 asyncio并发编程"></a>第十三章 asyncio并发编程</h1><h4 id="事件循环"><a href="#事件循环" class="headerlink" title="事件循环"></a>事件循环</h4><p>使用asyncio</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#事件循环+回调（驱动生成器）+epoll(IO多路复用)</span></span><br><span class="line"><span class="comment">#asyncio是python用于解决异步io编程的一整套解决方案</span></span><br><span class="line"><span class="comment">#tornado、gevent、twisted（scrapy， django channels）</span></span><br><span class="line"><span class="comment">#torando(实现web服务器)， django+flask(uwsgi, gunicorn+nginx)</span></span><br><span class="line"><span class="comment">#tornado可以直接部署， nginx+tornado</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> asyncio</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">get_html</span><span class="params">(url)</span>:</span></span><br><span class="line">    print(<span class="string">"start get url"</span>)</span><br><span class="line">    <span class="keyword">await</span> asyncio.sleep(<span class="number">2</span>)</span><br><span class="line">    print(<span class="string">"end get url"</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">"__main__"</span>:</span><br><span class="line">    start_time = time.time()</span><br><span class="line">    loop = asyncio.get_event_loop()</span><br><span class="line">    tasks = [get_html(<span class="string">"http://www.imooc.com"</span>) <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">10</span>)]</span><br><span class="line">    loop.run_until_complete(asyncio.wait(tasks))</span><br><span class="line">    print(time.time()-start_time)</span><br></pre></td></tr></table></figure>



<p>获取协程的返回值</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> asyncio</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">from</span> functools <span class="keyword">import</span> partial</span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">get_html</span><span class="params">(url)</span>:</span></span><br><span class="line">    print(<span class="string">"start get url"</span>)</span><br><span class="line">    <span class="keyword">await</span> asyncio.sleep(<span class="number">2</span>)</span><br><span class="line">    <span class="keyword">return</span> <span class="string">"bobby"</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">callback</span><span class="params">(url, future)</span>:</span></span><br><span class="line">    print(url)</span><br><span class="line">    print(<span class="string">"send email to bobby"</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">"__main__"</span>:</span><br><span class="line">    start_time = time.time()</span><br><span class="line">    loop = asyncio.get_event_loop()</span><br><span class="line">    <span class="comment"># get_future = asyncio.ensure_future(get_html("http://www.imooc.com"))</span></span><br><span class="line">    task = loop.create_task(get_html(<span class="string">"http://www.imooc.com"</span>))</span><br><span class="line">    task.add_done_callback(partial(callback, <span class="string">"http://www.imooc.com"</span>))</span><br><span class="line">    loop.run_until_complete(task)</span><br><span class="line">    print(task.result())</span><br></pre></td></tr></table></figure>

<p>注：</p>
<p>1、callback是一个回调函数，作用是做完耗时操作后想做某一件事，例如发送邮件，可以用这种方法进行操作，必须接受一个future对象作为参数，加入task.add_done_callback后默认会添加future对象</p>
<p>2、</p>
<p>get_future = asyncio.ensure_future(get_html(“<a href="http://www.imooc.com&quot;" target="_blank" rel="noopener">http://www.imooc.com&quot;</a>))</p>
<p>loop.run_until_complete(get_future)</p>
<p>与</p>
<p>task = loop.create_task(get_html(“<a href="http://www.imooc.com&quot;" target="_blank" rel="noopener">http://www.imooc.com&quot;</a>))</p>
<p>loop.run_until_complete(task)</p>
<p>作用相同，task是get_future的一个子类</p>
<p>wait 和 gather</p>
<p>asyncio.wait和asyncio.gather是等待一定条件（默认是所有任务执行完）满足后再继续执行下面的步骤</p>
<p>添加参数，也可以修改成第一个任务后就继续执行主线程</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> asyncio</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">get_html</span><span class="params">(url)</span>:</span></span><br><span class="line">    print(<span class="string">"start get url"</span>)</span><br><span class="line">    <span class="keyword">await</span> asyncio.sleep(<span class="number">2</span>)</span><br><span class="line">    print(<span class="string">"end get url"</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">"__main__"</span>:</span><br><span class="line">    start_time = time.time()</span><br><span class="line">    loop = asyncio.get_event_loop()</span><br><span class="line">    tasks = [get_html(<span class="string">"http://www.imooc.com"</span>) <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">10</span>)]</span><br><span class="line">    <span class="comment"># loop.run_until_complete(asyncio.wait(tasks))</span></span><br><span class="line">    <span class="comment"># loop.run_until_complete(asyncio.gather(*tasks))</span></span><br><span class="line">    <span class="comment"># print(time.time()-start_time)</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">#gather和wait的区别</span></span><br><span class="line">    <span class="comment">#gather更加high-level</span></span><br><span class="line">    <span class="comment"># gather可以进行分组</span></span><br><span class="line">    group1 = [get_html(<span class="string">"http://projectsedu.com"</span>) <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">2</span>)]</span><br><span class="line">    group2 = [get_html(<span class="string">"http://www.imooc.com"</span>) <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">2</span>)]</span><br><span class="line">    group1 = asyncio.gather(*group1)</span><br><span class="line">    group2 = asyncio.gather(*group2)</span><br><span class="line">    group2.cancel() <span class="comment"># 对未执行的分组进行取消</span></span><br><span class="line">    loop.run_until_complete(asyncio.gather(group1, group2))</span><br><span class="line">    print(time.time() - start_time)</span><br></pre></td></tr></table></figure>
    </div>
    
    <div class="post-footer">
        <div>
            
            转载声明：
            商业转载请联系作者获得授权,非商业转载请注明出处 © <a href="" target="_blank">Snippet</a>
            
            
        </div>
        <div>
            
        </div>
    </div>
</article>
<div class="article-nav prev-next-wrap clearfix">
    
    <a href="/2020/05/16/others/pycharm%E5%BF%AB%E6%8D%B7%E9%94%AE%E5%A4%A7%E5%85%A8/" class="pre-post btn btn-default" title='pycharm快捷键大全'>
        <i class="fa fa-angle-left fa-fw"></i><span class="hidden-lg">上一篇</span>
        <span class="hidden-xs">
            pycharm快捷键大全</span>
    </a>
    
    
    <a href="/2020/05/16/python/numpy%E5%92%8Cpandas/" class="next-post btn btn-default" title='numpy和pandas'>
        <span class="hidden-lg">下一篇</span>
        <span class="hidden-xs">
            numpy和pandas</span><i class="fa fa-angle-right fa-fw"></i>
    </a>
    
</div>

<div id="comments">
    

<div id="vcomments" class="valine"></div>

<script src="//cdn1.lncld.net/static/js/3.0.4/av-min.js"></script>
<script src="/assets/valine.min.js"></script>

<script>
new Valine({
    av: AV,
    el: '#vcomments',
    appId: 'xOKV9J4UeQAtVkvnJC7Kq2Jn-gzGzoHsz',
    appKey: 'erIpQac4azoCmgfBB7Dl9maa',
    placeholder: '说点什么吧',
    notify: false,
    verify: true,
    avatar: 'mm',
    meta: 'nick,mail'.split(','),
    pageSize: '10',
    path: window.location.pathname,
    lang: 'zh-CN'.toLowerCase()
})
</script>


</div>

                </main>
                
                    <aside id="article-toc" role="navigation" class="col-md-4">
    <div class="widget">
        <h3 class="title">
            文章目录
        </h3>
        
        <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#第二章-一切皆对象"><span class="toc-text">第二章 一切皆对象</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#函数和类也是对象，属于python的一等公民"><span class="toc-text">函数和类也是对象，属于python的一等公民</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#type、class、object之间的关系"><span class="toc-text">type、class、object之间的关系</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#第三章-魔法函数"><span class="toc-text">第三章 魔法函数</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#getitem"><span class="toc-text">__getitem__</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#repr"><span class="toc-text">__repr__</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#str"><span class="toc-text">__str__</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#abs"><span class="toc-text">__abs__</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#add"><span class="toc-text">__add__</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#len"><span class="toc-text">__len__</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#mro"><span class="toc-text">__mro__</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#dict"><span class="toc-text">__dict__</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#enter-、-exit"><span class="toc-text">__enter__、__exit__</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#getattr-、-getattribute"><span class="toc-text">__getattr__、__getattribute__</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#第四章-深入类和对象"><span class="toc-text">第四章 深入类和对象</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#鸭子类型和多态"><span class="toc-text">鸭子类型和多态</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#抽象基类-abc模块"><span class="toc-text">抽象基类(abc模块)</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#isinstance和type"><span class="toc-text">isinstance和type</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#数据封装和私有属性"><span class="toc-text">数据封装和私有属性</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#python对象的自省机制"><span class="toc-text">python对象的自省机制</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#super函数"><span class="toc-text">super函数</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#mixin混合模式"><span class="toc-text">mixin混合模式</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#异常处理和上下文管理器"><span class="toc-text">异常处理和上下文管理器</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#简化上下文管理器"><span class="toc-text">简化上下文管理器</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#第五章-自定义序列类"><span class="toc-text">第五章 自定义序列类</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#序列类型区分"><span class="toc-text">序列类型区分</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#、-、extend、append"><span class="toc-text">+、+&#x3D;、extend、append</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#切片"><span class="toc-text">切片</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#bisect管理可排序序列"><span class="toc-text">bisect管理可排序序列</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#什么时候我们不该使用列表"><span class="toc-text">什么时候我们不该使用列表</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#列表推导式、生成器表达式、字典推导式、集合推导式"><span class="toc-text">列表推导式、生成器表达式、字典推导式、集合推导式</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#第六章-深入python的set和dict"><span class="toc-text">第六章 深入python的set和dict</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#dict的常用方法"><span class="toc-text">dict的常用方法</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#dict的子类"><span class="toc-text">dict的子类</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#set、fronzenset"><span class="toc-text">set、fronzenset</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#dict和set的实现原理"><span class="toc-text">dict和set的实现原理</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#第七章-对象引用、可变性和垃圾回收"><span class="toc-text">第七章 对象引用、可变性和垃圾回收</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#一个经典的错误"><span class="toc-text">一个经典的错误</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#第八章-元类编程"><span class="toc-text">第八章 元类编程</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#property属性"><span class="toc-text">property属性</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#属性描述符"><span class="toc-text">属性描述符</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#自定义元类"><span class="toc-text">自定义元类</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#通过元类实现ORM"><span class="toc-text">通过元类实现ORM</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#第九章-迭代器和生成器"><span class="toc-text">第九章 迭代器和生成器</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#可迭代对象和迭代器"><span class="toc-text">可迭代对象和迭代器</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#生成器"><span class="toc-text">生成器</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#第十章-python-socket编程"><span class="toc-text">第十章 python socket编程</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#客户端"><span class="toc-text">客户端</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#服务端"><span class="toc-text">服务端</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#第十一章-多线程、多进程和线程池编程"><span class="toc-text">第十一章 多线程、多进程和线程池编程</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#GIL锁-全局解释器锁"><span class="toc-text">GIL锁(全局解释器锁)</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#多线程编程"><span class="toc-text">多线程编程</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#线程间通信-共享变量和Queue"><span class="toc-text">线程间通信-共享变量和Queue</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#线程同步-Lock、RLock"><span class="toc-text">线程同步 - Lock、RLock</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#condition"><span class="toc-text">condition</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#semaphore"><span class="toc-text">semaphore</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#ThreadPoolExecutor线程池"><span class="toc-text">ThreadPoolExecutor线程池</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#multiprocessing-多进程编程"><span class="toc-text">multiprocessing 多进程编程</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#进程间通信-Queue、Pipe，Manager"><span class="toc-text">进程间通信 - Queue、Pipe，Manager</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#第十二章-协程和异步IO"><span class="toc-text">第十二章 协程和异步IO</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#并发、并行、同步、异步、阻塞、非阻塞"><span class="toc-text">并发、并行、同步、异步、阻塞、非阻塞</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#I-O多路复用"><span class="toc-text">I&#x2F;O多路复用</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#select-回调-事件循环获取html"><span class="toc-text">select+回调+事件循环获取html</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#生成器-1"><span class="toc-text">生成器</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#yield-from"><span class="toc-text">yield from</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#第十三章-asyncio并发编程"><span class="toc-text">第十三章 asyncio并发编程</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#事件循环"><span class="toc-text">事件循环</span></a></li></ol></li></ol></li></ol></li></ol>
        
    </div>
</aside>
                
            </div>
        </div>
    </section>
    <footer class="main-footer">
    <div class="container">
        <div class="row">
        </div>
    </div>
</footer>
<a id="back-to-top" class="icon-btn hide">
    <i class="fa fa-chevron-up"></i>
</a>
    <div class="copyright">
    <div class="container">
        <div class="row">
            <div class="col-sm-12">
                <div class="busuanzi">
    
</div>
            </div>
            <div class="col-sm-12">
                <span>Copyright &copy;
                    2017
                    
                </span> |
                <span>
                    Powered by <a href="//hexo.io" class="copyright-links" target="_blank" rel="nofollow">Hexo</a>
                </span> |
                <span>
                    Theme by <a href="//github.com/shenliyang/hexo-theme-snippet.git" class="copyright-links" target="_blank" rel="nofollow">Snippet</a>
                </span>
            </div>
        </div>
    </div>
</div>




<script src="/js/app.js?rev=@@hash.js"></script>

</body>
</html>